The bytefield package∗
Scott Pakin
scott+bf@pakin.org
March 2, 2025
Abstract
The bytefield package helps the user create illustrations for network pro-
tocol specifications and anything else that utilizes fields of data. These
illustrations show how the bits and bytes are laid out in a packet or in
memory.
Warning: bytefield version 2.x breaks compatibility
with older versions of the package. See Section 2.7
for help porting documents to the new interface.
1 Introduction
Network protocols are usually specified in terms of a sequence of bits and bytes
arranged in a field. This is portrayed graphically as a grid of boxes. Each row
in the grid represents one word (frequently, 8, 16, or 32 bits), and each column
represents a bit within a word. The bytefield package makes it easy to typeset
these sorts of figures. bytefield facilitates drawing protocol diagrams that contain
• words of any arbitrary number of bits,
• column headers showing bit positions,
• multiword fields—even non-word-aligned and even if the total number of bits
is not a multiple of the word length,
• word labels on either the left or right of the figure, and
• “skipped words” within fields.
Because bytefield draws its figures using only the LATEX picture environment,
these figures are not specific to any particular backend, do not require PostScript
or PDF support, and do not need support from external programs. Furthermore,
unlike an imported graphic, bytefield pictures can include arbitrary LATEX con-
structs, such as mathematical equations, \refs and \cites to the surrounding
document, and macro calls.
∗This document corresponds to bytefield v2.9, dated 2025/01/25.
1
2 Usage
2.1 A first example
The Internet Engineering Task Force’s Request for Comments (RFC) number 3016
includes the following ASCII-graphics illustration of the RTP packetization of an
MPEG-4 Visual bitstream:
0 1 2 3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|V=2|P|X| CC |M| PT | sequence number | RTP
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| timestamp | Header
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| synchronization source (SSRC) identifier |
+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+
| contributing source (CSRC) identifiers |
| .... |
+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+
| | RTP
| MPEG-4 Visual stream (byte aligned) | Pay-
| | load
| +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| :...OPTIONAL RTP padding |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
The following LATEX code shows how straightforward it is to typeset that illustra-
tion using the bytefield package:
\begin{bytefield}[bitwidth=1.1em]{32}
\bitheader{0-31} \\
\begin{rightwordgroup}{RTP \\ Header}
\bitbox{2}{V=2} & \bitbox{1}{P} & \bitbox{1}{X}
& \bitbox{4}{CC} & \bitbox{1}{M} & \bitbox{7}{PT}
& \bitbox{16}{sequence number} \\
\bitbox{32}{timestamp}
\end{rightwordgroup} \\
\bitbox{32}{synchronization source (SSRC) identifier} \\
\wordbox[tlr]{1}{contributing source (CSRC) identifiers} \\
\wordbox[blr]{1}{$\cdots$} \\
\begin{rightwordgroup}{RTP \\ Payload}
\wordbox[tlr]{3}{MPEG-4 Visual stream (byte aligned)} \\
\bitbox[blr]{16}{}
& \bitbox{16}{\dots\emph{optional} RTP padding}
\end{rightwordgroup}
\end{bytefield}
Figure 1 presents the typeset output of the preceding code. Sections 2.2 and 2.3
explain each of the environments, macros, and arguments that were utilized plus
many additional features of the bytefield package.
2
2.2 Basic commands
This section explains how to use the bytefield package. It lists all of the exported
macros and environments in approximately decreasing order of usefulness.
\begin{bytefield} [⟨options⟩] {⟨bit-width⟩}
⟨fields⟩
\end{bytefield}
The bytefield package’s top-level environment is called, not surprisingly,
“bytefield”. It takes one mandatory argument, which is the number of bits
in each word, and one optional argument, which is a comma-separated list of
⟨key⟩=⟨value⟩ pairs, described in Section 2.3, for formatting the bit-field’s layout.
One can think of a bytefield as being analogous to a tabular: words are sepa-
rated by “\\”, and fields within a word are separated by “&”. As in a tabular,
“\\” accepts a ⟨length⟩ as an optional argument, and this specifies the amount of
additional vertical whitespace to include after the current word is typeset.
\bitbox [⟨sides⟩] {⟨width⟩} [⟨options⟩] {⟨text⟩}
\wordbox [⟨sides⟩] {⟨height⟩} [⟨options⟩] {⟨text⟩}
The two main commands one uses within a bytefield environment are \bitbox
and \wordbox. The former typesets a field that is one or more bits wide and a
single word tall. The latter typesets a field that is an entire word wide and one or
more words tall.
The first, optional, argument, ⟨sides⟩, is a list of letters specifying which sides
of the field box to draw—[l]eft, [r]ight, [t]op, and/or [b]ottom. The default is
“lrtb” (i.e., all sides are drawn). The second, required, argument is the width in
bits of a bit box or the height in words of a word box. The third argument is an
optional, comma-separated list of ⟨key⟩=⟨value⟩ pairs, described in Section 2.3.
The fourth, required, argument is the text to typeset within the box. It is typeset
horizontally centered within a vertically centered \parbox. Hence, words will
wrap, and “\\” can be used to break lines manually.
The following example shows how to produce a simple 16-bit-wide field:
\begin{bytefield}{16}
\wordbox{1}{A 16-bit field} \\
\bitbox{8}{8 bits} & \bitbox{8}{8 more bits} \\
\wordbox{2}{A 32-bit field. Note that text wraps within the box.}
\end{bytefield}
The resulting bit field looks like this:
A 16-bit field
8 bits 8 more bits
A 32-bit field. Note that text
wraps within the box.
3
It is the user’s responsibility to ensure that the total number of bits in each
row adds up to the number of bits in a single word (the mandatory argument
to the bytefield environment); bytefield does not currently check for under- or
overruns.
Here’s an example of using the bgcolor option to fill each box with a different
color:
\definecolor{lightcyan}{rgb}{0.84,1,1}
\definecolor{lightgreen}{rgb}{0.64,1,0.71}
\definecolor{lightred}{rgb}{1,0.7,0.71}
\begin{bytefield}[bitheight=\widthof{~Sign~},
boxformatting={\centering\small}]{32}
\bitheader[endianness=big]{31,23,0} \\
\bitbox{1}[bgcolor=lightcyan]{\rotatebox{90}{Sign}} &
\bitbox{8}[bgcolor=lightgreen]{Exponent} &
\bitbox{23}[bgcolor=lightred]{Mantissa}
\end{bytefield}
31 23 0
Sign
Exponent Mantissa
Within a \bitbox or \wordbox, the bytefield package defines \height, \depth,
\totalheight, and \width to the corresponding dimensions of the box. Sec-
tion 2.4 gives an example of how these lengths may be utilized.
\bitboxes [⟨sides⟩] {⟨width⟩} [⟨options⟩] {⟨tokens⟩}
\bitboxes* [⟨sides⟩] {⟨width⟩} [⟨options⟩] {⟨tokens⟩}
The \bitboxes command provides a shortcut for typesetting a sequence of
fields of the same width. It takes essentially the same arguments as \bitbox but
interpets these differently. Instead of representing a single piece of text to typeset
within a field of width ⟨width⟩, \bitboxes’s ⟨tokens⟩ argument represents a list
of tokens (e.g, individual characters), each of which is typeset within a separate
box of width ⟨width⟩. Consider, for example, the following sequence of \bitbox
commands:
\begin{bytefield}{8}
\bitbox{1}{D} & \bitbox{1}{R} & \bitbox{1}{M} & \bitbox{1}{F} &
\bitbox{1}{S} & \bitbox{1}{L} & \bitbox{1}{T} & \bitbox{1}{D}
\end{bytefield}
D RMF S L T D
With \bitboxes this can be abbreviated to
\begin{bytefield}{8}
\bitboxes{1}{DRMFSLTD}
\end{bytefield}
4
Spaces are ignored within \bitboxes’s ⟨text⟩ argument, and curly braces can
be used to group multiple characters into a single token:
\begin{bytefield}{24}
\bitboxes{3}{{DO} {RE} {MI} {FA} {SOL} {LA} {TI} {DO}}
\end{bytefield}
DO RE MI FA SOL LA TI DO
The starred form of \bitboxes is identical except that it suppresses all internal
vertical lines. It can therefore be quite convenient for typesetting binary constants:
\begin{bytefield}{16}
\bitboxes*{1}{01000010} & \bitbox{4}{src\strut} &
\bitbox{4}{dest\strut} & \bitbox{4}{const\strut}
\end{bytefield}
0 1 0 0 0 0 1 0 src dest const
\bitheader [⟨options⟩] {⟨bit-positions⟩}
To make the bit field more readable, it helps to label bit positions across the
top. The \bitheader command provides a flexible way to do that. The optional
argument is a comma-separated list of ⟨key⟩=⟨value⟩ pairs from the set described
in Section 2.3. In practice, the only parameters that are meaningful in the context
of \bitheader are bitformatting, endianness, and lsb. See Section 2.3 for
descriptions and examples of those parameters.
\bitheader’s mandatory argument, ⟨bit-positions⟩, is a comma-separated list
of bit positions to label. For example, “0,2,4,6,8,10,12,14” means to label
those bit positions. The numbers must be listed in increasing order. (Use the
endianness parameter to display the header in reverse order.) Hyphen-separated
ranges are also valid. For example, “0-15” means to label all bits from 0 to 15, in-
clusive. Ranges and single numbers can even be intermixed, as in “0-3,8,12-15”.
The following example shows how \bitheader may be used:
\begin{bytefield}{32}
\bitheader{0-31} \\
\bitbox{4}{Four} & \bitbox{8}{Eight} &
\bitbox{16}{Sixteen} & \bitbox{4}{Four}
\end{bytefield}
The resulting bit field looks like this:
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
Four Eight Sixteen Four
5
\begin{rightwordgroup} [⟨options⟩] {⟨text⟩}
⟨rows of bit boxes and word boxes⟩
\end{rightwordgroup}
\begin{leftwordgroup} [⟨options⟩] {⟨text⟩}
⟨rows of bit boxes and word boxes⟩
\end{leftwordgroup}
When a set of words functions as a single, logical unit, it helps to group these
words together visually. All words defined between \begin{rightwordgroup}
and \end{rightwordgroup} will be labeled on the right with ⟨text⟩. Similarly,
all words defined between \begin{leftwordgroup} and \end{leftwordgroup}
will be labeled on the left with ⟨text⟩. \begin{⟨side⟩wordgroup} must lie at the
beginning of a row (i.e., right after a “\\”), and \end{⟨side⟩wordgroup} must lie
right before the end of the row (i.e., right before a “\\”).
The optional argument is a comma-separated list of ⟨key⟩=⟨value⟩ pairs
from the set described in Section 2.3. In practice, only curlystyle,
leftcurlystyle, and rightcurlystyle, make sense within the context of a
\begin{⟨side⟩wordgroup}.
Unlike other LATEX environments, rightwordgroup and leftwordgroup
do not have to nest properly with each other. However, they can-
not overlap themselves. In other words, \begin{rightwordgroup}. . .
\begin{leftwordgroup}. . .\end{rightwordgroup}. . .\end{leftwordgroup} is a
valid sequence, but \begin{rightwordgroup}. . .\begin{rightwordgroup}. . .
\end{rightwordgroup}. . .\end{rightwordgroup} is not.
The following example presents the basic usage of \begin{rightwordgroup}
and \end{rightwordgroup}:
\begin{bytefield}{16}
\bitheader{0,7,8,15} \\
\begin{rightwordgroup}{Header}
\bitbox{4}{Tag} & \bitbox{12}{Mask} \\
\bitbox{8}{Source} & \bitbox{8}{Destination}
\end{rightwordgroup} \\
\wordbox{3}{Data}
\end{bytefield}
Note the juxtaposition of “\\” to the \begin{rightwordgroup} and the
\end{rightwordgroup} in the above. The resulting bit field looks like this:
0 7 8 15
Tag Mask
Source Destination


 Header
Data
As a more complex example, the following nests left and right labels:
\begin{bytefield}{16}
6
\bitheader{0,7,8,15} \\
\begin{rightwordgroup}{Header}
\bitbox{4}{Tag} & \bitbox{12}{Mask} \\
\begin{leftwordgroup}{Node IDs}
\bitbox{8}{Source} & \bitbox{8}{Destination}
\end{leftwordgroup}
\end{rightwordgroup} \\
\wordbox{3}{Data}
\end{bytefield}
0 7 8 15
Tag Mask
Source DestinationNode IDs
n


 Header
Data
Because rightwordgroup and leftwordgroup are not required to nest properly,
the resulting bit field would look the same if the \end{leftwordgroup} and
\end{rightwordgroup} were swapped. Again, note the justaposition of “\\”
to the various word-grouping commands in the above.
\skippedwords
Draw a graphic representing a number of words that are not shown.
\skippedwords is intended to work with the ⟨sides⟩ argument to \wordbox, as in
the following example:
\begin{bytefield}{16}
\wordbox{1}{Some data} \\
\wordbox[lrt]{1}{Lots of data} \\
\skippedwords \\
\wordbox[lrb]{1}{} \\
\wordbox{2}{More data}
\end{bytefield}
Some data
Lots of data
hhhhhhhhhhhhhhh
hhhhhhhhhhhhhhh
More data
7
\bytefieldsetup {⟨options⟩}
Alter the formatting of all subsequent bit fields. Section 2.3 describes
the possible values for each ⟨key⟩=⟨value⟩ pair in the comma-separated list
that \bytefieldsetup accepts as its argument. Note that changes made with
\bytefieldsetup are local to their current scope. Hence, if used within an envi-
ronment (e.g., figure), \bytefieldsetup does not impact bit fields drawn outside
that environment.
2.3 Formatting options
A document author can customize many of the bytefield package’s figure-formatting
parameters, either globally or on a per-figure basis. The parameters described
below can be specified in six locations:
• as package options (i.e., in the \usepackage[⟨options⟩]{bytefield} line),
which affects all bytefield environments in the entire document,
• anywhere in the document using the \bytefieldsetup command, which
affects all subsequent bytefield environments in the current scope,
• as the optional argument to a \begin{bytefield}, which affects only that
single bit-field figure, or
• as the optional argument to a \bitheader, which affects only that particular
header. (Only a few parameters are meaningful in this context.)
• as the optional argument to a \begin{leftwordgroup} or
\begin{rightwordgroup}, which affects only that particular word
group. (Only a few parameters are meaningful in this context.)
• as the second optional argument to a \bitbox, \wordbox, or \bitboxes,
which affects only that particular box. (Only a few parameters are mean-
ingful in this context.)
Unfortunately, LATEX tends to abort with a “TeX capacity exceeded” or
“Missing \endcsname inserted” error when a control sequence (i.e., \⟨name⟩)
or \⟨symbol ⟩) is encountered within the optional argument to \usepackage.
Hence, parameters that typically expect a control sequence in their argument—
in particular, bitformatting, boxformatting, leftcurly, and rightcurly—
should best be avoided within the \usepackage[⟨options⟩]{bytefield} line.
bitwidth = ⟨length⟩
bitheight = ⟨length⟩
The above parameters represent the width and height of each bit in a bit field.
The default value of bitwidth is the width of “{\tiny 99i}”, i.e., the width of a
two-digit number plus a small amount of extra space. This enables \bitheader to
show two-digit numbers without overlap. The default value of bitheight is 2ex,
which should allow a normal piece of text to appear within a \bitbox or \wordbox
without abutting the box’s top or bottom edge.
8
As a special case, if bitwidth is set to the word “auto”, it will be set to the
width of “99i” in the current bit-number formatting (see bitformatting below).
This feature provides a convenient way to adjust the bit width after a formatting
change.
endianness = little or big
Specify either little-endian (left-to-right) or big-endian (right-to-left) ordering
of the bit numbers. The default is little-endian numbering. Contrast the following
two examples. The first formats a bit field in little-endian ordering using an
explicit endianness=little, and the second formats the same bit field in big-
endian ordering using endianness=big.
\begin{bytefield}[endianness=little,bitwidth=0.11111\linewidth]{8}
\bitheader{0-7} \\
\bitbox{1}{Res} & \bitbox{1}{BE} & \bitbox{1}{CF}
& \bitbox{3}{$\mbox{Name\_Len}-1$} & \bitbox{2}{Len\_Len} \\
\end{bytefield}
0 1 2 3 4 5 6 7
Res BE CF Name Len − 1 Len Len
\begin{bytefield}[endianness=big,bitwidth=0.11111\linewidth]{8}
\bitheader{0-7} \\
\bitbox{2}{Len\_Len} & \bitbox{3}{$\mbox{Name\_Len}-1$}
& \bitbox{1}{CF} & \bitbox{1}{BE} & \bitbox{1}{Res} \\
\end{bytefield}
01234567
Len Len Name Len − 1 CF BE Res
bitformatting = ⟨command ⟩ or {⟨commands⟩}
The numbers that appear in a bit header are typeset in the bitformatting
style, which defaults to \tiny. To alter the style of bit numbers in the bit header,
set bitformatting to a macro that takes a single argument (like \textbf) or no
arguments (like \small). Groups of commands (e.g., {\large\itshape}) are also
acceptable.
When bitformatting is set, bitwidth usually needs to be recalculated as
well to ensure that a correct amount of spacing surrounds each number in the bit
header. As described above, setting bitwidth=auto is a convenient shortcut for
recalculating the bit-width in the common case of bit fields containing no more
9
than 99 bits per line and no particularly wide labels in bit boxes that contain only
a few bits.
The following example shows how to use bitformatting and bitwidth to
format a bit header with small, boldface text:
\begin{bytefield}[bitformatting={\small\bfseries},
bitwidth=auto,
endianness=big]{20}
\bitheader{0-19} \\
\bitbox{1}{\tiny F/E} & \bitbox{1}{\tiny T0} & \bitbox{1}{\tiny T1}
& \bitbox{1}{\tiny Fwd} & \bitbox{16}{Data value} \\
\end{bytefield}
The resulting bit field looks like this:
012345678910111213141516171819
F/E T0 T1 Fwd Data value
boxformatting = ⟨command ⟩ or {⟨commands⟩}
The text that appears in a \bitbox or \wordbox is formatted in the
boxformatting style, which defaults to \centering. To alter the style of bit
numbers in the bit header, set boxformatting to a macro that takes a single ar-
gument (like \textbf but not \textbf—see below) or no arguments (like \small).
Groups of commands (e.g., {\large\itshape}) are also acceptable.
If boxformatting is set to a macro that takes an argument, the macro must be
defined as a “long” macro, which means it can accept more than one paragraph as
an argument. Commands defined with \newcommand are automatically made long,
but commands defined with \newcommand* are not. LATEX’s \text. . . formatting
commands (e.g., \textbf) are not long and therefore cannot be used directly in
boxformatting; use the zero-argument versions (e.g., \bfseries) instead.
The following example shows how to use boxformatting to format the text
within each box horizontally centered and italicized:
\begin{bytefield}[boxformatting={\centering\itshape},
bitwidth=1.5em,
endianness=big]{20}
\bitheader{0-19} \\
\bitbox{1}{\tiny F/E} & \bitbox{1}{\tiny T0} & \bitbox{1}{\tiny T1}
& \bitbox{1}{\tiny Fwd} & \bitbox{16}{Data value} \\
\end{bytefield}
The resulting bit field looks like this:
012345678910111213141516171819
F/E T0 T1 Fwd Data value
10
bgcolor = ⟨color ⟩
Bit and word boxes are normally left unfilled. The bgcolor option fills them
with a specified background color. A document will need to include the color,
xcolor, or similar package to expose color names to bytefield. The boxformatting
option described above can be used to set the foreground color.
leftcurly = ⟨delimiter ⟩
rightcurly = ⟨delimiter ⟩
Word groups are normally indicated by a curly brace spanning all of its rows.
However, the curly brace can be replaced by any other extensible math delimiter
(i.e., a symbol that can meaningfully follow \left or \right in math mode) via a
suitable redefinition of leftcurly or rightcurly. As in math mode, “.” means
“no symbol”, as in the following example (courtesy of Steven R. King):
\begin{bytefield}[rightcurly=., rightcurlyspace=0pt]{32}
\bitheader[endianness=big]{0,7,8,15,16,23,24,31} \\
\begin{rightwordgroup}{0Ch}
\bitbox{8}{Byte 15 \\ \tiny (highest address)}
& \bitbox{8}{Byte 14}
& \bitbox{8}{Byte 13}
& \bitbox{8}{Byte 12}
\end{rightwordgroup} \\
\begin{rightwordgroup}{08h}
\bitbox{32}{Long 0}
\end{rightwordgroup} \\
\begin{rightwordgroup}{04h}
\bitbox{16}{Word 1} & \bitbox{16}{Word 0}
\end{rightwordgroup} \\
\begin{rightwordgroup}{00h}
\bitbox{8}{Byte 3}
& \bitbox{8}{Byte 2}
& \bitbox{8}{Byte 1}
& \bitbox{8}{Byte 0 \\ \tiny (lowest address)}
\end{rightwordgroup}
\end{bytefield}
0781516232431
Byte 15
(highest address) Byte 14 Byte 13 Byte 12 0Ch
Long 0 08h
Word 1 Word 0 04h
Byte 3 Byte 2 Byte 1 Byte 0
(lowest address) 00h
leftcurlyspace = ⟨length⟩
rightcurlyspace = ⟨length⟩
curlyspace = ⟨length⟩
leftcurlyspace and rightcurlyspace specify the space to insert between the
11
bit field and the curly brace in a left or right word group (default: 1ex). Setting
curlyspace is a shortcut for setting both leftcurlyspace and rightcurlyspace
to the same value.
leftlabelspace = ⟨length⟩
rightlabelspace = ⟨length⟩
labelspace = ⟨length⟩
leftlabelspace and rightlabelspace specify the space to insert between the
curly brace and the text label in a left or right word group (default: 0.5ex). Setting
labelspace is a shortcut for setting both leftlabelbrace and rightlabelspace
to the same value.
Figure 2 illustrates the juxtaposition of rightcurlyspace and
rightlabelspace to a word group and its label. The leftcurlyspace
and leftlabelspace parameters are symmetric.
leftcurlyshrinkage = ⟨length⟩
rightcurlyshrinkage = ⟨length⟩
curlyshrinkage = ⟨length⟩
In TEX/LATEX, the height of a curly brace does not include the tips. Hence, in
a word group label, the tips of the curly brace will extend beyond the height of
the word group. leftcurlyshrinkage/rightcurlyshrinkage is an amount by
which to reduce the height of the curly brace in a left/right word group’s label.
Setting curlyshrinkage is a shortcut for setting both leftcurlyshrinkage and
rightcurlyshrinkage to the same value. Shrinkages default to 5pt, and it is
extremely unlikely that one would ever need to change them. Nevertheless, these
parameters are included here in case a document is typeset with a math font con-
taining radically different curly braces from the ones that come with TEX/LATEX
or that replaces the curly braces (using leftcurly/rightcurly, described above)
with symbols of substantially different heights.
leftcurlystyle = ⟨command ⟩
rightcurlystyle = ⟨command ⟩
curlystyle = ⟨command ⟩
Provide a macro that will be invoked before the code that draws left, right, or
both curly braces. The macro must accept either zero or one argument. It can be
used, for example, to color the curly brace:
\begin{bytefield}[curlystyle=\color{blue}]{16}
\bitheader{0-15} \\
\begin{rightwordgroup}{Sign-extended}
\bitbox{4}{Tag} & \bitbox{12}{Data}
\end{rightwordgroup} \\
\end{bytefield}
12
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
Tag Data
o
Sign-extended
or
\begin{bytefield}{16}
\bitheader{0-15} \\
\begin{rightwordgroup}[curlystyle=\color{blue}]{Sign-extended}
\bitbox{4}{Tag} & \bitbox{12}{Data}
\end{rightwordgroup} \\
\end{bytefield}
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
Tag Data
o
Sign-extended
lsb = ⟨integer ⟩
Designate the least significant bit (LSB) in the bit header. By default, the LSB
is zero, which means that the first bit position in the header corresponds to bit 0.
Specifying a different LSB shifts the bit header such that the first bit position
instead corresponds to ⟨integer ⟩. Note that the lsb option affects bit positions
regardless of whether these positions are labeled, as demonstrated by the following
two examples:
\begin{bytefield}{32}
\bitheader[lsb=0]{4,12,20,28} \\
\bitbox{16}{ar\$hrd} & \bitbox{16}{ar\$pro} \\
\bitbox{8}{ar\$hln} & \bitbox{8}{ar\$pln} & \bitbox{16}{ar\$op} \\
\end{bytefield}
4 12 20 28
ar$hrd ar$pro
ar$hln ar$pln ar$op
\begin{bytefield}{32}
\bitheader[lsb=4]{4,12,20,28} \\
\bitbox{16}{ar\$hrd} & \bitbox{16}{ar\$pro} \\
\bitbox{8}{ar\$hln} & \bitbox{8}{ar\$pln} & \bitbox{16}{ar\$op} \\
\end{bytefield}
4 12 20 28
ar$hrd ar$pro
ar$hln ar$pln ar$op
13
perword = ⟨command ⟩
Provide a macro that will be invoked once for each word in a word box after
the regular content is rendered. The macro will be passed two arguments: the
word number (starting from 0) and the total number of words in the word box.
Furthermore, the macro will be invoked within a one-word-wide box positioned at
the base of the word. perword can therefore be used for delineating words within
a word box, numbering words, or performing other such annotations. As a simple
example, the following code draws a gray line at the bottom of each word in the
“Descriptive text” word box:
\newcommand{\wordline}[2]{\color[rgb]{0.7,0.7,0.7}\hrulefill}
\begin{bytefield}[bitwidth=4em]{8}
\bitheader[lsb=1,bitformatting=\small]{1-8} \\
\wordbox[lrt]{7}[perword=\wordline]{Descriptive text (60 bytes)} \\
\bitbox[lrb]{4}{} & \bitbox{4}{subsys data offset} \\
\bitbox{4}{subsys data offset} & \bitbox{2}{version} &
\bitbox{2}{endian indicator} \\
\end{bytefield}
1 2 3 4 5 6 7 8
Descriptive text (60 bytes)
subsys data offset
subsys data offset version endian indicator
2.4 Common tricks
This section shows some clever ways to use bytefield’s commands to produce some
useful effects.
Odd-sized fields To produce a field that is, say, 1½ words long, use a \bitbox
for the fractional part and specify appropriate values for the various ⟨sides⟩ pa-
rameters. For instance:
\begin{bytefield}{16}
\bitheader{0,7,8,15} \\
\bitbox{8}{8-bit field} & \bitbox[lrt]{8}{} \\
14
\wordbox[lrb]{1}{24-bit field}
\end{bytefield}
0 7 8 15
8-bit field
24-bit field
Ellipses To skip words that appear the middle of enumerated data, put some
\vdots in a \wordbox with empty ⟨sides⟩:
\begin{bytefield}{16}
\bitbox{8}{Type} & \bitbox{8}{\# of nodes} \\
\wordbox{1}{Node~1} \\
\wordbox{1}{Node~2} \\
\wordbox[]{1}{$\vdots$} \\[1ex]
\wordbox{1}{Node~$N$}
\end{bytefield}
Type # of nodes
Node 1
Node 2
...
Node N
The extra 1ex of vertical space helps vertically center the \vdots a bit better.
Narrow fields There are a number of options for labeling a narrow field
(e.g., one occupying a single bit):
Default: OK Data
\bytefieldsetup{% OK Data
bitwidth=\widthof{OK~}}:
\tiny OK: OK Data
\tiny O \\ K: O
K Data
\rotatebox{90}{\small OK}:
OK
Data
\let\bw=\width OK Data
\resizebox{\bw}{!}{~OK~}:
15
Multi-line bit fields Presentations of wide registers are often easier to read
when split across multiple lines. (This capability was originally requested by Chris
L’Esperance and is currently implemented in bytefield based on code provided by
Renaud Pacalet.) The trick behind the typesetting of multi-line bit fields is to
pass the lsb option to \bitheader to change the starting bit number used in each
bit header:
\begin{bytefield}[endianness=big,bitwidth=2em]{16}
\bitheader[lsb=16]{16-31} \\
\bitbox{1}{\tiny Enable} & \bitbox{7}{Reserved}
& \bitbox{8}{Bus} \\[3ex]
\bitheader{0-15} \\
\bitbox{5}{Device} & \bitbox{3}{Function} & \bitbox{6}{Register}
& \bitbox{2}{00}
\end{bytefield}
16171819202122232425262728293031
Enable Reserved Bus
0123456789101112131415
Device Function Register 00
Note the use of the optional argument to \\ to introduce three x-heights of
additional whitespace between the two rows of bits.
Rotated bit labels A problem with using very large bit numbers is that the
labels run into each other, as in the following example:
\begin{bytefield}[endianness=big]{8}
\bitheader[lsb=995]{995-1002} \\
\bitbox{4}{A} & \bitbox{4}{B}
\end{bytefield}
995996997998999100010011002
A B
One solution is to use the bitformatting option and the graphicx package’s
\rotatebox command to rotate each bit label by 90°. Unfortunately, the naive
use of bitformatting and \rotatebox does not typeset nicely:
\begin{bytefield}[endianness=big]{8}
\bitheader[lsb=995,
bitformatting={\tiny\rotatebox[origin=B]{90}}]{995-1002} \\
\bitbox{4}{A} & \bitbox{4}{B}
\end{bytefield}
16
995
996
997
998
999
1000
1001
1002
A B
The two problems are that (1) the numbers are left-justified, and (2) the num-
bers touch the top margin of the word box. To address these problems we use
\makebox to construct a right-justified region that is sufficiently wide to hold our
largest number plus some additional space to shift the rotated numbers upwards:
\newlength{\bitlabelwidth}
\newcommand{\rotbitheader}[1]{%
\tiny
\settowidth{\bitlabelwidth}{\quad 9999}%
\rotatebox[origin=B]{90}{\makebox[\bitlabelwidth][r]{#1}}%
}
\begin{bytefield}[endianness=big]{8}
\bitheader[lsb=995,bitformatting=\rotbitheader]{995-1002} \\
\bitbox{4}{A} & \bitbox{4}{B}
\end{bytefield}
995
996
997
998
999
1000
1001
1002
A B
Unused bits The bgcolor option can be used to represent unused bits by spec-
ifying a background fill color—light gray looks nice—and empty text:
\definecolor{lightgray}{gray}{0.8}
\begin{bytefield}{32}
\bitheader{0,4,8,12,16,20,24,28} \\
\bitbox{8}{Tag} & \bitbox{8}{Value} &
\bitbox{4}[bgcolor=lightgray]{} &
\bitbox{12}{Mask} \\
\wordbox{1}{Key}
\end{bytefield}
0 4 8 12 16 20 24 28
Tag Value Mask
Key
Aligning text on the baseline Because bytefield internally uses LATEX’s
picture environment and that environment’s \makebox command to draw bit
boxes and word boxes, the text within a box is centered vertically with no atten-
tion paid to the text’s baseline. As a result, some bit-field labels appear somewhat
askew:
\begin{bytefield}[bitwidth=1.5em]{2}
17
\bitbox{1}{M} & \bitbox{1}{y}
\end{bytefield}
M y
A solution is to use the boxformatting option to trick \makebox into thinking
that all text has the same height and depth. Here we use \raisebox to indicate
that all text is as tall as a “W” and does not descend at all below the baseline:
\newlength{\maxheight}
\setlength{\maxheight}{\heightof{W}}
\newcommand{\baselinealign}[1]{%
\centering
\raisebox{0pt}[\maxheight][0pt]{#1}%
}
\begin{bytefield}[boxformatting=\baselinealign,
bitwidth=1.5em]{2}
\bitbox{1}{M} & \bitbox{1}{y}
\end{bytefield}
M y
Register contents Sometimes, rather than listing the meaning of each bit field
within each \bitbox or \wordbox, it may be desirable to list the contents, with the
meaning described in an additional label above each bit number in the bit header.
Although the register package is more suited to this form of layout, bytefield can
serve in a pinch with the help of the \turnbox macro from the rotating package:
\newcommand{\bitlabel}[2]{%
\bitbox[]{#1}{%
\raisebox{0pt}[4ex][0pt]{%
\turnbox{45}{\fontsize{7}{7}\selectfont#2}%
}%
}%
}
\begin{bytefield}[bitwidth=1em]{16}
\bitlabel{1}{Carry} & \bitlabel{1}{Reserved} &
\bitlabel{1}{Parity} & \bitlabel{1}{Reserved} &
\bitlabel{1}{Adjust} & \bitlabel{1}{Reserved} &
\bitlabel{1}{Zero} & \bitlabel{1}{Sign} &
\bitlabel{1}{Trap} & \bitlabel{1}{Interrupt enable} &
\bitlabel{1}{Direction} & \bitlabel{1}{Overflow} &
\bitlabel{2}{I/O privilege level (12--13)} &
\bitlabel{1}{Nested task} & \bitlabel{1}{Reserved} \\
18
\bitheader{0-15} \\
\bitbox{1}{0} & \bitbox{1}{1} & \bitbox{1}{0} & \bitbox{1}{0} &
\bitbox{1}{0} & \bitbox{1}{0} & \bitbox{1}{0} & \bitbox{1}{1} &
\bitbox{1}{0} & \bitbox{1}{1} & \bitbox{1}{0} & \bitbox{1}{0} &
\bitbox{1}{0} & \bitbox{1}{0} & \bitbox{1}{0} & \bitbox{1}{0}
\end{bytefield}
Carry
Reserved
Parity
Reserved
Adjust
Reserved
Zero
Sign
Trap
Interrupt enable
Direction
Overflow
I/O privilege level (12–13)
Nested task
Reserved
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
0 1 0 0 0 0 0 1 0 1 0 0 0 0 0 0
2.5 Not-so-common tricks
Omitted bit numbers It is occasionally convenient to show a wide bit field in
which the middle numbers are replaced with an ellipsis. The trick to typesetting
such a thing with bytefield is to point the bitformatting option to a macro that
conditionally modifies the given bit number before outputting it. One catch is
that bytefield measures the height of the string “1234567890” using the current bit
formatting, so that needs to be a valid input. (If bitwidth is set to “auto”, then
“99i” also has to be a valid input, but we’re not using “auto” here.) The following
example shows how to conditionally modify the bit number: If the number is
1234567890, it is used as is; numbers greater than 9 are increased by 48; numbers
less than 4 are unmodified; the number 6 is replaced by an ellipsis; and all other
numbers are discarded.
\newcommand{\fakesixtyfourbits}[1]{%
\tiny
\ifnum#1=1234567890
#1
\else
\ifnum#1>9
\count32=#1
\advance\count32 by 48
\the\count32%
\else
\ifnum#1<4
#1%
\else
\ifnum#1=6
$\cdots$%
\fi
\fi
\fi
\fi
}
\begin{bytefield}[%
19
bitwidth=\widthof{\tiny Fwd~},
bitformatting=\fakesixtyfourbits,
endianness=big]{16}
\bitheader{0-15} \\
\bitbox{1}{\tiny F/E} & \bitbox{1}{\tiny T0} & \bitbox{1}{\tiny T1}
& \bitbox{1}{\tiny Fwd} & \bitbox{12}{Data value}
\end{bytefield}
0123· · ·585960616263
F/E T0 T1 Fwd Data value
Memory-map diagrams While certainly not the intended purpose of the byte-
field package, one can utilize word boxes with empty ⟨sides⟩ and word labels to
produce memory-map diagrams:
\newcommand{\descbox}[2]{\parbox[c][3.8\baselineskip]{0.95\width}{%
\raggedright #1\vfill #2}}
\begin{bytefield}[bitheight=4\baselineskip]{32}
\begin{rightwordgroup}{Partition 4}
\bitbox[]{8}{\texttt{0xFFFFFFFF} \\[2\baselineskip]
\texttt{0xC0000000}} &
\bitbox{24}{\descbox{1\,GB area for VxDs, memory manager,
file system code; shared by all processes.}{Read/writable.}}
\end{rightwordgroup} \\
\begin{rightwordgroup}{Partition 3}
\bitbox[]{8}{\texttt{0xBFFFFFFF} \\[2\baselineskip]
\texttt{0x80000000}} &
\bitbox{24}{\descbox{1\,GB area for memory-mapped files,
shared system \textsc{dll}s, file system code; shared by all
processes.}{Read/writable.}}
\end{rightwordgroup} \\
\begin{rightwordgroup}{Partition 2}
\bitbox[]{8}{\texttt{0x7FFFFFFF} \\[2\baselineskip]
\texttt{0x00400000}} &
\bitbox{24}{\descbox{$\sim$2\,GB area private to process,
process code, and data.}{Read/writable.}}
\end{rightwordgroup} \\
\begin{rightwordgroup}{Partition 1}
\bitbox[]{8}{\texttt{0x003FFFFF} \\[2\baselineskip]
\texttt{0x00001000}} &
\bitbox{24}{\descbox{4\,MB area for MS-DOS and Windows~3.1
compatibility.}{Read/writable.}} \\
\bitbox[]{8}{\texttt{0x00000FFF} \\[2\baselineskip]
\texttt{0x00000000}} &
\bitbox{24}{\descbox{4096~byte area for MS-DOS and Windows~3.1
compatibility.}{Protected---catches \textsc{null}
pointers.}}
\end{rightwordgroup}
\end{bytefield}
20
0xFFFFFFFF
0xC0000000
1 GB area for VxDs, memory manager, file
system code; shared by all processes.
Read/writable.



Partition 4
0xBFFFFFFF
0x80000000
1 GB area for memory-mapped files, shared
system dlls, file system code; shared by all
processes.
Read/writable.



Partition 3
0x7FFFFFFF
0x00400000
∼2 GB area private to process, process code,
and data.
Read/writable.



Partition 2
0x003FFFFF
0x00001000
4 MB area for MS-DOS and Windows 3.1
compatibility.
Read/writable.
0x00000FFF
0x00000000
4096 byte area for MS-DOS and Windows 3.1
compatibility.
Protected—catches null pointers.



Partition 1
The following variation uses variable-height regions in the memory map:
\newcommand{\memsection}[4]{%
% define the height of the memsection
\bytefieldsetup{bitheight=#3\baselineskip}%
\bitbox[]{10}{%
\texttt{#1}% print end address
\\
% do some spacing
\vspace{#3\baselineskip}
\vspace{-2\baselineskip}
\vspace{-#3pt}
\texttt{#2}% print start address
}%
\bitbox{16}{#4}% print box with caption
}
\begin{bytefield}{24}
\memsection{ffff ffff}{0040 0000}{15}{-- free --}\\
\begin{rightwordgroup}{internal memory}
\memsection{003f ffff}{002f c000}{4}{Special Function
Registers}\\
\memsection{002f bfff}{0007 0000}{3}{-- reserved --}\\
\memsection{0006 ffff}{0000 0000}{8}{Internal Flash}
\end{rightwordgroup}\\
\end{bytefield}
21
ffff ffff
0040 0000
– free –
003f ffff
002f c000
Special Function Registers
002f bfff
0007 0000
– reserved –
0006 ffff
0000 0000
Internal Flash



internal memory
2.6 Putting it all together
The following code showcases most of bytefield’s features in a single figure.
\begin{bytefield}[bitheight=2.5\baselineskip]{32}
\bitheader{0,7,8,15,16,23,24,31} \\
\begin{rightwordgroup}{\parbox{6em}{\raggedright These words were taken
verbatim from the TCP header definition (RFC~793).}}
\bitbox{4}{Data offset} & \bitbox{6}{Reserved} &
\bitbox{1}{\tiny U\\R\\G} & \bitbox{1}{\tiny A\\C\\K} &
\bitbox{1}{\tiny P\\S\\H} & \bitbox{1}{\tiny R\\S\\T} &
\bitbox{1}{\tiny S\\Y\\N} & \bitbox{1}{\tiny F\\I\\N} &
\bitbox{16}{Window} \\
\bitbox{16}{Checksum} & \bitbox{16}{Urgent pointer}
\end{rightwordgroup} \\
\wordbox[lrt]{1}{Data octets} \\
\skippedwords \\
\wordbox[lrb]{1}{} \\
\begin{leftwordgroup}{\parbox{6em}{\raggedright Note that we can display,
for example, a misaligned 64-bit value with clever use of the
22
optional argument to \texttt{\string\wordbox} and
\texttt{\string\bitbox}.}}
\bitbox{8}{Source} & \bitbox{8}{Destination} &
\bitbox[lrt]{16}{} \\
\wordbox[lr]{1}{Timestamp} \\
\begin{rightwordgroup}{\parbox{6em}{\raggedright Why two Length fields?
No particular reason.}}
\bitbox[lrb]{16}{} & \bitbox{16}{Length}
\end{leftwordgroup} \\
\bitbox{6}{Key} & \bitbox{6}{Value} & \bitbox{4}{Unused} &
\bitbox{16}{Length}
\end{rightwordgroup} \\
\wordbox{1}{Total number of 16-bit data words that follow this
header word, excluding the subsequent checksum-type value} \\
\bitbox{16}{Data~1} & \bitbox{16}{Data~2} \\
\bitbox{16}{Data~3} & \bitbox{16}{Data~4} \\
\bitbox[]{16}{$\vdots$ \\[1ex]} &
\bitbox[]{16}{$\vdots$ \\[1ex]} \\
\bitbox{16}{Data~$N-1$} & \bitbox{16}{Data~$N$} \\
\bitbox{20}{\[ \mbox{A5A5}_{\mbox{\scriptsize H}} \oplus
\left(\sum_{i=1}^N \mbox{Data}_i \right) \bmod 2^{20} \]} &
\bitboxes*{1}{000010 000110} \\
\wordbox{2}{64-bit random number}
\end{bytefield}
Figure 3 shows the resulting protocol diagram.
2.7 Upgrading from older versions
bytefield’s user interface changed substantially with the introduction of version 2.0.
Because documents written for bytefield v1.x will not build properly under later
versions of the package, this section explains how to convert documents to the new
interface.
\wordgroupr
\endwordgroupr
These have been replaced with the rightwordgroup environment to make
their invocation more LATEX-like. Use \begin{rightwordgroup} instead of
\wordgroupr and \end{rightwordgroup} instead of \endwordgroupr.
\wordgroupl
\endwordgroupl
These have been replaced with the leftwordgroup environment to make their
invocation more LATEX-like. Use \begin{leftwordgroup} instead of \wordgroupl
and \end{leftwordgroup} instead of \endwordgroupl.
\bitwidth
Instead of changing bit widths with \setlength{\bitwidth}{⟨width⟩}, use
23
\bytefieldsetup{bitwidth=⟨width⟩}.
\byteheight
Instead of changing bit heights with \setlength{\byteheight}{⟨height⟩},
use \bytefieldsetup{bitheight=⟨height⟩} (and note the change from “byte”
to “bit” for consistency with bitwidth).
\curlyspace
\labelspace
Instead of using \setlength{\curlyspace}{⟨dist⟩} and
\setlength{\labelspace}{⟨dist⟩} to alter the horizontal space that appears
before and after a curly brace, use \bytefieldsetup{curlyspace=⟨dist⟩} and
\bytefieldsetup{labelspace=⟨dist⟩}. Note that, as described in Section 2.2,
left and right spacing can be set independently if desired.
\curlyshrinkage
Instead of using \setlength{\curlyshrinkage}{⟨dist⟩} to reduce the vertical
space occupied by a curly brace, use \bytefieldsetup{curlyshrinkage=⟨dist⟩}.
Note that, as described in Section 2.2, left and right curly-brace height can be
reduced independently if desired.
\bitwidth [⟨endianness⟩] {⟨bit-positions⟩}
The meaning of \bitwidth’s optional argument changed with bytefield v2.1.
In older versions of the package, the optional argument was one of “l” or “b” for,
respectively, little-endian or big-endian bit ordering. Starting with version 2.1, the
optional argument can be any of the parameters described in Section 2.3 (but prac-
tically only bitformatting, endianness, and lsb). Hence, “l” should be replaced
with endianness=little and “b” should be replaced with endianness=big. Al-
though more verbose, these new options can be specified once for the entire doc-
ument by listing them as package options or as arguments to \bytefieldsetup.
As a crutch to help build older documents with minimal modification, bytefield
provides a compat1 package option that restores the old interface. This option,
invoked with \usepackage[compat1]{bytefield}, may disappear in a future ver-
sion of the package and should therefore not be relied upon as a long-term approach
to using bytefield.
3 Implementation
This section contains the complete source code for bytefield. Most users will not
get much out of it, but it should be of use to those who need more precise docu-
mentation and those who want to extend (or debug ,) the bytefield package.
In this section, macros marked in the margin with a “⋆” are intended to be
called by the user (and were described in Section 2). All other macros are used
24
only internally by bytefield.
3.1 Required packages
Although \widthof and \heightof were introduced in June 1998, teTEX 2.0—
still in widespread use at the time of this writing (2005)—ships with an earlier
calc.sty in the source directory. Because a misconfigured system may find the
source version of calc.sty we explicitly specify a later date when loading the
calc package.
1 \RequirePackage{calc}[1998/07/07]
2 \RequirePackage{keyval}
3.2 Utility macros
The following macros in this section are used by the box-drawing macros and the
“skipped words”-drawing macros.
\bf@newdimen@old LATEX’s \newdimen defines new ⟨dimen⟩s globally. \bf@newdimen@old defines
them locally. It simply merges LATEX 2ε’s \newdimen and \alloc@ macros while
omitting \alloc@’s “\global” declaration. The “old” in the name implies that
\bf@newdimen@old is intended for use with older versions of LATEX.
3 \def\bf@newdimen@old#1{\advance\count11 by 1
4 \ch@ck1\insc@unt\dimen
5 \allocationnumber=\count11
6 \dimendef#1=\allocationnumber
7 \wlog{\string#1=\string\dimen\the\allocationnumber\space (locally)}%
8 }
\bf@e@alloc Since 2014, LATEX has provided an internal \e@alloc macro that is used to define
\newcount, \newdimen, \newskip, etc. \bf@e@alloc is a version of \e@alloc
modified to allocate only within the current scope. (It elides all uses of \global.)
We use \bf@e@alloc to define \bf@newdimen, which allocates a locally scoped
⟨dimen⟩.
9 \def\bf@e@alloc#1#2#3#4#5#6{%
10 \advance#3\@ne
11 \e@ch@ck{#3}{#4}{#5}#1%
12 \allocationnumber#3\relax
13 #2#6\allocationnumber
14 \wlog{\string#6=\string#1\the\allocationnumber\space (locally)}%
15 }
\bf@newdimen bytefield allocates a number of ⟨dimen⟩s, largely for positioning curly braces. Be-
cause TEX supports only 255 ⟨dimen⟩s, these normally would run out quickly for
documents containing many bit fields. ε-TEX provides many more ⟨dimen⟩s that
the original TEX, but it still would be preferable not to consume them unneces-
sarily.
This is where \bf@newdimen comes in. If the elocalloc package is loaded,
\bf@newdimen is bound to elocalloc’s \locdimen macro. Otherwise, if \e@alloc
is defined—this is the common case—then \bf@newdimen is defined in terms of
\bf@e@alloc just like \newdimen is defined in terms of \e@alloc. As a last resort,
\bf@newdimen is bound to \bf@newdimen@old for use with old versions of LATEX.
16 \AtBeginDocument{%
25
Is elocalloc loaded?
17 \expandafter\ifx\csname locdimen\endcsname\relax
No. Are we running a reasonably recent LATEX?
18 \expandafter\ifx\csname e@alloc\endcsname\relax
No. Use \bf@newdimen@old, which was designed in terms of primitives found in
older versions of LATEX.
19 \global\let\bf@newdimen=\bf@newdimen@old
20 \else
We are running a reasonably recent LATEX. Define \bf@newdimen in terms of
\bf@e@alloc, which allocates ⟨dimen⟩s locally.
21 \gdef\bf@newdimen{%
22 \bf@e@alloc\dimen \dimendef {\count11}\insc@unt\float@count
23 }%
24 \fi
25 \else
elocalloc is loaded. Define \bf@newdimen in terms of elocalloc’s \locdimen macro.
26 \let\bf@newdimen=\locdimen
27 \fi
28 }
\bytefield@height
\ifcounting@words
When \ifcounting@words is true, add the height of the next picture envi-
ronment to \bytefield@height. We set \counting@wordstrue at the begin-
ning of each word, and \counting@wordsfalse after each \bitbox, \wordbox, or
\skippedwords picture.
29 \newlength{\bytefield@height}
30 \newif\ifcounting@words
\inc@bytefield@height We have to define a special macro to increment \bytefield@height because
the calc package’s \addtolength macro doesn’t seem to see the global value.
So we \setlength a temporary (to get calc’s nice infix features) and \advance
\bytefield@height by that amount.
31 \newlength{\bytefield@height@increment}
32 \DeclareRobustCommand{\inc@bytefield@height}[1]{%
33 \setlength{\bytefield@height@increment}{#1}%
34 \global\advance\bytefield@height by \bytefield@height@increment
35 }
3.3 Top-level environment
\entire@bytefield@picture Declare a box for containing the entire bytefield. By storing everything in a box
and then typesetting it later (at the \end{bytefield}), we can center the bit
field, put a box around it, and do other operations on the entire figure.
36 \newsavebox{\entire@bytefield@picture}
⋆ bytefield (env.)
\bits@wide
\old@nl
\amp
The bytefield environment contains the layout of bits in a sequence of words.
This is the main environment defined by the bytefield package. The argument is
the number of bits wide the bytefield should be. We turn & into a space character
so the user can think of a bytefield as being analogous to a tabular environment,
26
even though we’re really setting the bulk of the picture in a single column. (Row
labels go in separate columns, however.)
37 \newenvironment{bytefield}[2][]{%
38 \bf@bytefieldsetup{#1}%
39 \renewcommand{\baselinestretch}{}%
40 \selectfont
41 \def\bits@wide{#2}%
42 \let\old@nl=\\%
43 \let\amp=&%
44 \catcode‘\&=10
45 \openup -1pt
46 \setlength{\bytefield@height}{0pt}%
47 \setlength{\unitlength}{1pt}%
48 \global\counting@wordstrue
49 \begin{lrbox}{\entire@bytefield@picture}%
⋆ \\ We redefine \\ within the bytefield environment to make it aware of curly braces
that surround the protocol diagram.
50 \renewcommand{\\}[1][0pt]{%
51 \unskip
52 \vspace{##1}%
53 \amp\show@wordlabelr\cr
54 \ignorespaces\global\counting@wordstrue\make@lspace\amp}%
55 \vbox\bgroup\ialign\bgroup##\amp##\amp##\cr\amp
56 }{%
57 \unskip
58 \amp\show@wordlabelr\cr\egroup\egroup
59 \end{lrbox}%
60 \usebox{\entire@bytefield@picture}%
61 }
3.4 Box-drawing macros
3.4.1 Drawing (proper)
\bf@bitformatting Format a bit number in the bit header. \bf@bitformatting may be redefined to
take either a single argument (`a la \textbf) or no argument (`a la \small).
62 \newcommand*{\bf@bitformatting}{\tiny}
\bf@boxformatting Format the text within a bit box or word box. \bf@boxformatting takes either
a single argument (`a la \textbf) or no argument (`a la \small). The text that
follows \bf@boxformatting is guaranteed to be a group that ends in \par, so
if \bf@boxformatting accepts an argument, the macro should be defined with
\long (e.g., with \newcommand but not with \newcommand*).
63 \newcommand*{\bf@boxformatting}{\centering}
\bf@bitwidth Define the width of a single bit. Note that this is wide enough to display a two-
digit number without it running into adjacent numbers. For larger words, be sure
to \setlength this larger.
64 \newlength{\bf@bitwidth}
65 \settowidth{\bf@bitwidth}{\bf@bitformatting{99i}}
27
\bf@bitheight This is the height of a single bit within the bit field.
66 \newlength{\bf@bitheight}
67 \setlength{\bf@bitheight}{4ex}
\units@wide
\units@tall
These are scratch variables for storing the width and height (in points) of the box
we’re about to draw.
68 \newlength{\units@wide}
69 \newlength{\units@tall}
\bf@call@box@cmd
\bf@call@box@func
Define any box-drawing macro that accepts the same set of four arguments.
It takes as input the name of a macro that is defined with formal parameters
[#1]#2[#3]#4. \bf@call@box@cmd then invokes that macro, passing it a set of
lines to draw out of the set “lrtbLRTB” (#1), a number of bits or words (#2), a
list of key/value pairs (#3), and arbitrary text to typeset (#4).
70 \newcommand*{\bf@call@box@cmd}[1]{%
71 \def\bf@call@box@func{#1}%
72 \bf@call@box@cmd@i
73 }
\bf@call@box@cmd@i
\bf@call@box@arg@i
\bf@call@box@arg@ii
Store the set of lines and the bit/word count and invoke \bf@call@box@cmd@ii.
74 \newcommand*{\bf@call@box@cmd@i}[2][lrtb]{%
75 \def\bf@call@box@arg@i{#1}%
76 \def\bf@call@box@arg@ii{#2}%
77 \bf@call@box@cmd@ii
78 }
\bf@call@box@cmd@ii
\bf@call@box@arg@iii
\bf@call@box@arg@iv
Store the key/value parameters and the text to typeset then invoke the macro
originally passed to \bf@call@box@cmd.
79 \newcommand*{\bf@call@box@cmd@ii}[2][]{%
80 \def\bf@call@box@arg@iii{#1}%
81 \def\bf@call@box@arg@iv{#2}%
82 \bf@call@box@func
83 }
⋆ \bitbox Put some text (#4) in a box that’s a given number of bits (#2) wide and one byte
tall. An optional argument (#1) specifies which lines to draw—[l]eft, [r]ight,
[t]op, and/or [b]ottom (default: lrtb). Additional drawing parameters can be
provided via another optional argument (#3).
84 \DeclareRobustCommand{\bitbox}{\bf@call@box@cmd{\bf@bitbox}}
\bf@bitbox Implement all of the \bitbox logic.
85 \def\bf@bitbox{%
86 \bgroup
87 \expandafter\bf@parse@bitbox@arg\expandafter{\bf@call@box@arg@i}%
88 \setlength{\units@wide}{\bf@bitwidth * \bf@call@box@arg@ii}%
89 \expandafter\bf@bytefieldsetup\expandafter{\bf@call@box@arg@iii}%
90 \@ifundefined{bf@bgcolor}{%
91 }{%
If bgcolor was specified, draw a colored rule of the full size of the box.
92 \rlap{%
93 \draw@bit@picture{\strip@pt\units@wide}{\strip@pt\bf@bitheight}{%
94 \color{\bf@bgcolor}%
28
95 \rule{\width}{\height}%
96 }%
97 }%
98 }%
Draw the user-provided text on top of the rule (if any).
99 \draw@bit@picture{\strip@pt\units@wide}{\strip@pt\bf@bitheight}{%
100 \bf@call@box@arg@iv
101 }%
102 \egroup
103 \ignorespaces
104 }
⋆ \wordbox Put some text (#4) in a box that’s a given number of bytes (#2) tall and one
word (\bits@wide bits) wide. An optional argument (#1) specifies which lines
to draw—[l]eft, [r]ight, [t]op, and/or [b]ottom (default: lrtb). Additional
drawing parameters can be provided via another optional argument (#3).
105 \DeclareRobustCommand{\wordbox}{\bf@call@box@cmd{\bf@wordbox}}
\bf@wordbox Implement all of the \wordbox logic.
106 \def\bf@wordbox{%
107 \bgroup
108 \expandafter\bf@parse@bitbox@arg\expandafter{\bf@call@box@arg@i}%
109 \setlength{\units@wide}{\bf@bitwidth * \bits@wide}%
110 \setlength{\units@tall}{\bf@bitheight * \bf@call@box@arg@ii}%
111 \expandafter\bf@bytefieldsetup\expandafter{\bf@call@box@arg@iii}%
112 \@ifundefined{bf@bgcolor}{%
113 }{%
If bgcolor was specified, draw a colored rule of the full size of the box.
114 \rlap{%
115 \draw@bit@picture{\strip@pt\units@wide}{\strip@pt\units@tall}{%
116 \color{\bf@bgcolor}%
117 \rule{\width}{\height}%
118 }%
119 }%
120 }%
Draw the user-provided text on top of the rule (if any).
121 \draw@bit@picture{\strip@pt\units@wide}{\strip@pt\units@tall}{%
122 \bf@call@box@arg@iv
123 }%
Invoke the user-provided \bf@per@word macro once per word.
124 \@ifundefined{bf@per@word}{}{\bf@invoke@per@word{\bf@call@box@arg@ii}}%
125 \egroup
126 \ignorespaces
127 }
\draw@bit@picture Put some text (#3) in a box that’s a given number of units (#1) wide and a
given number of units (#2) tall. We format the text with a \parbox to enable
word-wrapping and explicit line breaks. In addition, we define \height, \depth,
\totalheight, and \width (`a la \makebox and friends), so the user can utilize
those for special effects (e.g., a \rule that fills the entire box). As an added bonus,
29
we define \widthunits and \heightunits, which are the width and height of the
box in multiples of \unitlength (i.e., #1 and #2, respectively).
128 \DeclareRobustCommand{\draw@bit@picture}[3]{%
129 \begin{picture}(#1,#2)%
First, we plot the user’s text, with all sorts of useful lengths predefined.
130 \put(0,0){\makebox(#1,#2){\parbox{#1\unitlength}{%
131 \bf@set@user@dimens{#1}{#2}%
132 \bf@boxformatting{#3\par}}}}%
Next, we draw each line individually. I suppose we could make a special case for
“all lines” and use a \framebox above, but the following works just fine.
133 \ifbitbox@top
134 \put(0,#2){\line(1,0){#1}}%
135 \fi
136 \ifbitbox@bottom
137 \put(0,0){\line(1,0){#1}}%
138 \fi
139 \ifbitbox@left
140 \put(0,0){\line(0,1){#2}}%
141 \fi
142 \ifbitbox@right
143 \put(#1,0){\line(0,1){#2}}%
144 \fi
145 \end{picture}%
Finally, we indicate that we’re no longer at the beginning of a word. The following
code structure (albeit with different arguments to \inc@bytefield@height) is
repeated in various places throughout this package. We document it only here,
however.
146 \ifcounting@words
147 \inc@bytefield@height{\unitlength * \real{#2}}%
148 \global\counting@wordsfalse
149 \fi
150 }
\bf@invoke@per@word Invoke \bf@per@word once per word, passing it the (0-indexed) word number and
total number of words.
151 \newcommand{\bf@invoke@per@word}[1]{%
152 \begin{picture}(0,0)%
153 \@tempcnta=0
154 \@tempdima=#1\bf@bitheight
Make various useful dimensions available to \bf@per@word.
155 \bf@set@user@dimens{\strip@pt\units@wide}{\strip@pt\units@tall}%
156 \loop
157 \advance\@tempdima by -\bf@bitheight
158 \bgroup
159 \put(-\strip@pt\units@wide, \strip@pt\@tempdima){%
160 \expandafter\bf@per@word\expandafter{\the\@tempcnta}{#1}%
161 }%
162 \egroup
163 \advance\@tempcnta by 1\relax
164 \ifnum#1>\@tempcnta
165 \repeat
30
166 \end{picture}%
167 }
\bf@set@user@dimens
⋆
⋆
⋆
⋆
⋆
⋆
\width
\height
\depth
\totalheight
\widthunits
\heightunits
Given a width in bits (#1) and a height in words (#2), make a number of box
dimensions available to the author: \width, \height, \depth, \totalheight.
Additionally, make the arguments available to the author via the \widthunits
and \heightunits macros.
168 \newcommand{\bf@set@user@dimens}[2]{%
169 \bf@newdimen\width
170 \bf@newdimen\height
171 \bf@newdimen\depth
172 \bf@newdimen\totalheight
173 \width=#1\unitlength
174 \height=#2\unitlength
175 \depth=0pt%
176 \totalheight=#2\unitlength
177 \def\widthunits{#1}%
178 \def\heightunits{#2}%
179 }
⋆
⋆ \bitboxes
\bitboxes*
Put each token in #3 into a box that’s a given number of bits (#2) wide and
one byte tall. An optional argument (#1) specifies which lines to draw—[l]eft,
[r]ight, [t]op, and/or [b]ottom (default: lrtb). The *-form of the command
omits interior left and right lines.
180 \DeclareRobustCommand{\bitboxes}{%
181 \@ifstar
182 {\bf@call@box@cmd{\bf@bitboxes@star}}%
183 {\bf@call@box@cmd{\bf@bitboxes@no@star}}%
184 }
\bf@relax Define a macro that expands to \relax for use with \ifx tests against
\bf@bitboxes@arg, which can contain either tokens to typeset or \relax.
185 \def\bf@relax{\relax}
\bf@bitboxes@no@star Implement the unstarred version of \bitboxes. This macro simply expands
its text argument into a list of tokens followed by \relax then invokes
\bf@bitboxes@no@star@i.
186 \def\bf@bitboxes@no@star{%
187 \expandafter\bf@bitboxes@no@star@i\bf@call@box@arg@iv\relax
188 \ignorespaces
189 }
\bf@bitboxes@no@star@i Walk the subsequent tokens one-by-one until \relax is encountered. For
each token, invoke \bf@bitbox (the internal version of \bitbox for which
\bf@call@box@arg@⟨number ⟩ are all defined.
190 \def\bf@bitboxes@no@star@i#1{%
191 \def\bf@call@box@arg@iv{#1}%
192 \ifx\bf@call@box@arg@iv\bf@relax
193 \let\next=\relax
194 \else
195 \bf@bitbox
31
196 \let\next=\bf@bitboxes@no@star@i
197 \fi
198 \next
199 }
\bf@bitboxes@star
\bf@bitboxes@sides
Implement the starred version of \bitboxes. This macro simply stores the original
⟨sides⟩ argument in \bf@bitboxes@sides, expands its text argument into a list
of tokens followed by two \relaxes, and invokes \bf@bitboxes@star@i.
200 \def\bf@bitboxes@star{%
201 \edef\bf@bitboxes@sides{\bf@call@box@arg@i}%
202 \expandafter\bf@bitboxes@star@i\bf@call@box@arg@iv\relax\relax
203 \ignorespaces
204 }
\bf@bitboxes@star@i
\bf@call@box@arg@iv
\bf@bitboxes@arg@ii
\next
Process the first token in the text argument passed to \bitboxes*. If it’s also the
last token (indicated by its being followed by \relax), draw an ordinary bit box
with all sides present. If it’s not the last token, draw a bit box with the right side
suppressed and invoke \bf@bitboxes@star@ii on the remaining tokens.
205 \def\bf@bitboxes@star@i#1#2{%
206 \def\bf@call@box@arg@iv{#1}%
207 \def\bf@bitboxes@arg@ii{#2}%
208 \ifx\bf@bitboxes@arg@ii\bf@relax
209 \bf@bitbox
210 \let\next=\relax
211 \else
212 \edef\bf@call@box@arg@i{\bf@bitboxes@sides R}%
213 \bf@bitbox
214 \def\next{\bf@bitboxes@star@ii{#2}}%
215 \fi
216 \next
217 }
\bf@bitboxes@star@ii
\bf@call@box@arg@iv
\bf@bitboxes@arg@ii
\next
Process the second and subsequent tokens in the text argument passed to
\bitboxes*. If the next token in the stream is the final one (indicated by its
being followed by \relax), draw a bit box with the left side suppressed. If it’s
not the final token, draw a bit box with both the left and right sides suppressed
and invoke itself recursively on the remaining tokens.
218 \def\bf@bitboxes@star@ii#1#2{%
219 \def\bf@call@box@arg@iv{#1}%
220 \def\bf@bitboxes@arg@ii{#2}%
221 \ifx\bf@bitboxes@arg@ii\bf@relax
222 \edef\bf@call@box@arg@i{\bf@bitboxes@sides L}%
223 \else
224 \edef\bf@call@box@arg@i{\bf@bitboxes@sides LR}%
225 \fi
226 \ifx\bf@call@box@arg@iv\bf@relax
227 \let\next=\relax
228 \else
229 \bf@bitbox
230 \def\next{\bf@bitboxes@star@ii{#2}}%
231 \fi
232 \next
233 }
32
3.4.2 Parsing arguments
The macros in this section are used to parse the optional argument to \bitbox,
\wordbox, and \bitboxes, which is some subset of {l, r, t, b, L, R, T, B} and de-
faults to “lrtb” for all three user macros. If the argument is empty, no lines are
drawn. Lowercase letters in the argument display, respectively, the left, right, top,
or bottom side of a box. Uppercase letters undo the effect of the corresponding,
prior, lowercase letter and are used internally by \bitboxes to suppress internal
left and right lines.
\ifbitbox@top
\ifbitbox@bottom
\ifbitbox@left
\ifbitbox@right
These macros are set to true if we’re to draw the corresponding edge on the
subsequent \bitbox or \wordbox.
234 \newif\ifbitbox@top
235 \newif\ifbitbox@bottom
236 \newif\ifbitbox@left
237 \newif\ifbitbox@right
\bf@parse@bitbox@arg This main parsing macro merely resets the above conditionals and calls a helper
function, \bf@parse@bitbox@sides.
238 \def\bf@parse@bitbox@arg#1{%
239 \bitbox@topfalse
240 \bitbox@bottomfalse
241 \bitbox@leftfalse
242 \bitbox@rightfalse
243 \bf@parse@bitbox@sides#1X%
244 }
\bf@parse@bitbox@sides The helper function for \bf@parse@bitbox@arg parses a single letter, sets the
appropriate conditional to true, and calls itself tail-recursively until it sees an “X”.
245 \def\bf@parse@bitbox@sides#1{%
246 \ifx#1X%
247 \else
248 \ifx#1t%
249 \bitbox@toptrue
250 \else
251 \ifx#1b%
252 \bitbox@bottomtrue
253 \else
254 \ifx#1l%
255 \bitbox@lefttrue
256 \else
257 \ifx#1r%
258 \bitbox@righttrue
259 \else
260 \ifx#1T%
261 \bitbox@topfalse
262 \else
263 \ifx#1B%
264 \bitbox@bottomfalse
265 \else
266 \ifx#1L%
267 \bitbox@leftfalse
268 \else
33
269 \ifx#1R%
270 \bitbox@rightfalse
271 \else
272 \PackageWarning{bytefield}{Unrecognized box side ‘#1’}%
273 \fi
274 \fi
275 \fi
276 \fi
277 \fi
278 \fi
279 \fi
280 \fi
281 \expandafter\bf@parse@bitbox@sides
282 \fi
283 }
3.5 Skipped words
\units@high This is the height of each diagonal line in the \skippedwords graphic. Note that
\units@high = \units@tall − optional argument to \skippedwords.
284 \newlength{\units@high}
⋆ \skippedwords Output a fancy graphic representing skipped words. The optional argument is the
vertical space between the two diagonal lines (default: 2ex).
285 \DeclareRobustCommand{\skippedwords}[1][2ex]{%
286 \setlength{\units@wide}{\bf@bitwidth * \bits@wide}%
287 \setlength{\units@high}{1pt * \ratio{\units@wide}{6.0pt}}%
288 \setlength{\units@tall}{#1 + \units@high}%
289 \edef\num@wide{\strip@pt\units@wide}%
290 \edef\num@tall{\strip@pt\units@tall}%
291 \edef\num@high{\strip@pt\units@high}%
292 \begin{picture}(\num@wide,\num@tall)
293 \put(0,\num@tall){\line(6,-1){\num@wide}}
294 \put(\num@wide,0){\line(-6,1){\num@wide}}
295 \put(0,0){\line(0,1){\num@high}}
296 \put(\num@wide,\num@tall){\line(0,-1){\num@high}}
297 \end{picture}%
298 \ifcounting@words
299 \inc@bytefield@height{\unitlength * \real{\num@tall}}%
300 \global\counting@wordsfalse
301 \fi
302 }
3.6 Bit-position labels
\bf@bit@endianness bytefield can label bit headers in either little-endian (0, 1, 2, . . . , N − 1) or big-
endian (N − 1, N − 2, N − 3, . . . , 0) fashion. The \bf@bit@endianness macro
specifies which to use, either “l” for little-endian (the default) or “b” for big-
endian.
303 \newcommand*{\bf@bit@endianness}{l}
\bf@first@bit Normally, bits are numbered starting from zero. However, \bf@first@bit can be
altered (usually locally) to begin numbering from a different value.
34
304 \newcommand*{\bf@first@bit}{0}
⋆ \bitheader Output a header of numbered bit positions. The optional argument (#1) is “l”
for little-endian (default) or “b” for big-endian. The required argument (#2) is
a list of bit positions to label. It is composed of comma-separated ranges of
numbers, for example, “0-31”, “0,7-8,15-16,23-24,31”, or even something odd
like “0-7,15-23”. Ranges must be specified in increasing order; use the lsb option
to reverse the labels’ direction.
305 \DeclareRobustCommand{\bitheader}[2][]{%
306 \bf@parse@bitbox@arg{lrtb}%
307 \setlength{\units@wide}{\bf@bitwidth * \bits@wide}%
308 \setlength{\units@tall}{\heightof{\bf@bitformatting{1234567890}}}%
309 \setlength{\units@high}{\units@tall * -1}%
310 \bf@process@bitheader@opts{#1}%
311 \begin{picture}(\strip@pt\units@wide,\strip@pt\units@tall)%
312 (0,\strip@pt\units@high)
313 \bf@parse@range@list#2,X,
314 \end{picture}%
315 \ifcounting@words
316 \inc@bytefield@height{\unitlength * \real{\strip@pt\units@tall}}%
317 \global\counting@wordsfalse
318 \fi
319 \ignorespaces
320 }
\bf@parse@range@list This is helper function #1 for \bitheader. It parses a comma-separated list of
ranges, calling \bf@parse@range on each range.
321 \def\bf@parse@range@list#1,{%
322 \ifx X#1
323 \else
324 \bf@parse@range#1-#1-#1\relax
325 \expandafter\bf@parse@range@list
326 \fi
327 }
\header@xpos
header@val
max@header@val
Define some miscellaneous variables to be used internally by \bf@parse@range:
x position of header, current label to output, and maximum label to output (+1).
328 \newlength{\header@xpos}
329 \newcounter{header@val}
330 \newcounter{max@header@val}
\bf@parse@range This is helper function #2 for \bitheader. It parses a hyphen-separated pair of
numbers (or a single number) and displays the number at the correct bit position.
331 \def\bf@parse@range#1-#2-#3\relax{%
332 \setcounter{header@val}{#1}
333 \setcounter{max@header@val}{#2 + 1}
334 \loop
335 \ifnum\value{header@val}<\value{max@header@val}%
336 \if\bf@bit@endianness b%
337 \setlength{\header@xpos}{%
338 \bf@bitwidth * (\bits@wide - \value{header@val} + \bf@first@bit - 1)}%
339 \else
35
340 \setlength{\header@xpos}{\bf@bitwidth * (\value{header@val} - \bf@first@bit)}%
341 \fi
342 \put(\strip@pt\header@xpos,0){%
343 \makebox(\strip@pt\bf@bitwidth,\strip@pt\units@tall){%
344 \bf@bitformatting{\theheader@val}}}
345 \addtocounter{header@val}{1}
346 \repeat
347 }
\bf@process@bitheader@opts
\KV@bytefield@l
\KV@bytefield@b
\KV@bytefield@l@default
\KV@bytefield@b@default
This is helper function #3 for \bitheader. It processes the optional argument to
\bitheader.
348 \newcommand*{\bf@process@bitheader@opts}{%
349 \let\KV@bytefield@l=\KV@bitheader@l
350 \let\KV@bytefield@b=\KV@bitheader@b
351 \let\KV@bytefield@l@default=\KV@bitheader@l@default
352 \let\KV@bytefield@b@default=\KV@bitheader@b@default
353 \setkeys{bytefield}%
354 }
\KV@bitheader@l
\KV@bitheader@b
For backwards compatibility we also accept the (now deprecated) l as a synonym
for endianness=little and b as a synonym for endianness=big. A typical doc-
ument will specify an endianness option not as an argument to \bitheader
but rather as a package option that applies to the entire document. If the
compat1 option was provided to bytefield (determined below by the existence of the
\curlyshrinkage control word), we suppress the deprecation warning message.
355 \define@key{bitheader}{l}[true]{%
356 \expandafter\ifx\csname curlyshrinkage\endcsname\relax
357 \PackageWarning{bytefield}{%
358 The "l" argument to \protect\bitheader\space is deprecated.\MessageBreak
359 Instead, please use "endianness=little", which can\MessageBreak
360 even be declared globally for the entire document.\MessageBreak
361 This warning occurred}%
362 \fi
363 \def\bf@bit@endianness{l}%
364 }
365 \define@key{bitheader}{b}[true]{%
366 \expandafter\ifx\csname curlyshrinkage\endcsname\relax
367 \PackageWarning{bytefield}{%
368 The "b" argument to \protect\bitheader\space is deprecated.\MessageBreak
369 Instead, please use "endianness=big", which can\MessageBreak
370 even be declared globally for the entire document.\MessageBreak
371 This warning occurred}%
372 \fi
373 \def\bf@bit@endianness{b}%
374 }
3.7 Word labels
3.7.1 Curly-brace manipulation
\bf@leftcurlyshrinkage
\bf@rightcurlyshrinkage
Reduce the height of a left (right) curly brace by \bf@leftcurlyshrinkage
(\bf@rightcurlyshrinkage) so its ends don’t overlap whatever is above or below
it. The default value (5 pt.) was determined empirically and shouldn’t need to
36
be changed. However, on the off-chance the user employs a math font with very
different curly braces from Computer Modern’s, \bf@leftcurlyshrinkage and
\bf@rightcurlyshrinkage can be modified.
375 \def\bf@leftcurlyshrinkage{5pt}
376 \def\bf@rightcurlyshrinkage{5pt}
\bf@leftcurlyspace
\bf@rightcurlyspace
\bf@leftlabelspace
\bf@rightlabelspace
Define the amount of space to insert before a curly brace and before a word label
(i.e., after a curly brace).
377 \def\bf@leftcurlyspace{1ex}
378 \def\bf@rightcurlyspace{1ex}
379 \def\bf@leftlabelspace{0.5ex}
380 \def\bf@rightlabelspace{0.5ex}
\bf@leftcurly
\bf@rightcurly
Define the symbols to use as left and right curly braces. These symbols must be
extensible math symbols (i.e., they will immediately follow \left or \right in
math mode).
381 \let\bf@leftcurly=\{
382 \let\bf@rightcurly=\}
\bf@leftcurlystyle
\bf@rightcurlystyle
Define the default formatting for left and right curly braces as “do nothing special”.
383 \let\bf@leftcurlystyle=\relax
384 \let\bf@rightcurlystyle=\relax
\curly@box Define a box in which to temporarily store formatted curly braces.
385 \newbox{\curly@box}
\store@rcurly
\curly@height
\half@curly@height
\curly@shift
\old@axis
Store a “}” that’s #2 tall in box #1. The only unintuitive thing here is that we
have to redefine \fontdimen22—axis height—to 0 pt. before typesetting the curly
brace. Otherwise, the brace would be vertically off-center by a few points. When
we’re finished, we reset it back to its old value.
386 \def\store@rcurly#1#2{%
387 \begingroup
388 \bf@newdimen\curly@height
389 \setlength{\curly@height}{#2 - \bf@rightcurlyshrinkage}%
390 \bf@newdimen\half@curly@height
391 \setlength{\half@curly@height}{0.5\curly@height}%
392 \bf@newdimen\curly@shift
393 \setlength{\curly@shift}{\bf@rightcurlyshrinkage}%
394 \setlength{\curly@shift}{\half@curly@height + 0.5\curly@shift}%
395 \addtolength{\curly@shift}{-\fontdimen22\textfont2}%
396 \global\sbox{#1}{\raisebox{\curly@shift}{%
397 \bf@rightcurlystyle{%
398 $\left.
399 \vrule height\half@curly@height
400 width 0pt
401 depth\half@curly@height\right\bf@rightcurly$%
402 }%
403 }}%
404 \endgroup
405 }
\store@lcurly
\curly@height
\half@curly@height
\curly@shift
These are the same as \store@rcurly, etc. but using a “{” instead of a “}”.
37
406 \def\store@lcurly#1#2{%
407 \begingroup
408 \bf@newdimen\curly@height
409 \setlength{\curly@height}{#2 - \bf@leftcurlyshrinkage}%
410 \bf@newdimen\half@curly@height
411 \setlength{\half@curly@height}{0.5\curly@height}%
412 \bf@newdimen\curly@shift
413 \setlength{\curly@shift}{\bf@leftcurlyshrinkage}%
414 \setlength{\curly@shift}{\half@curly@height + 0.5\curly@shift}%
415 \addtolength{\curly@shift}{-\fontdimen22\textfont2}%
416 \global\sbox{#1}{\raisebox{\curly@shift}{%
417 \bf@leftcurlystyle{%
418 $\left\bf@leftcurly
419 \vrule height\half@curly@height
420 width 0pt
421 depth\half@curly@height\right.$%
422 }%
423 }}%
424 \endgroup
425 }
3.7.2 Right-side labels
\show@wordlabelr This macro is output in the third column of every row of the \ialigned bytefield
table. It’s normally a no-op, but \end{rightwordgroup} defines it to output the
word label and then reset itself to a no-op.
426 \def\show@wordlabelr{}
\wordlabelr@start
\wordlabelr@end
Declare the starting and ending height (in points) of the set of rows to be labeled
on the right.
427 \newlength{\wordlabelr@start}
428 \newlength{\wordlabelr@end}
⋆ rightwordgroup (env.) Label the words defined between \begin{rightwordgroup} and
\end{rightwordgroup} on the right side of the bit field. The first, op-
tional, argument is a list of parameters, as defined in Section 2.3. The second,
mandatory, argument is the text of the label. The label is typeset to the right of
a large curly brace, which groups the words together.
429 \newenvironment{rightwordgroup}[2][]{%
We begin by ending the group that \begin{rightwordgroup} created. This lets
the rightwordgroup environment span rows (because we’re technically no longer
within the environment).
430 \endgroup
\wordlabelr@start
\wordlabelr@params
\wordlabelr@text
\begin{rightwordgroup} merely stores the starting height in
\wordlabelr@start and the user-supplied text in \wordlabelr@text.
\end{rightwordgroup} does most of the work.
431 \global\wordlabelr@start=\bytefield@height
432 \gdef\wordlabelr@params{#1}%
433 \gdef\wordlabelr@text{#2}%
434 \ignorespaces
435 }{%
38
\wordlabelr@end Because we already ended the group that \begin{rightwordgroup} created we
now have to begin a group for \end{rightwordgroup} to end.
436 \begingroup
437 \global\wordlabelr@end=\bytefield@height
\show@wordlabelr Redefine \show@wordlabelr to output \bf@rightcurlyspace space, followed by
a large curly brace (in \curlybox), followed by \bf@rightlabelspace space, fol-
lowed by the user’s text (previously recorded in \wordlabelr@text). We typeset
\wordlabelr@text within a tabular environment, so LATEX will calculate its
width automatically.
438 \gdef\show@wordlabelr{%
439 \sbox{\word@label@box}{%
440 \begin{tabular}[b]{@{}l@{}}\wordlabelr@text\end{tabular}%
441 }%
442 \settowidth{\label@box@width}{\usebox{\word@label@box}}%
443 \setlength{\label@box@height}{\wordlabelr@end-\wordlabelr@start}%
Evaluate any parameters passed to \begin{rightwordgroup} right before we ren-
der the curly brace.
444 \expandafter\bf@bytefieldsetup\expandafter{\wordlabelr@params}%
445 \store@rcurly{\curly@box}{\label@box@height}%
446 \bf@newdimen\total@box@width
447 \setlength{\total@box@width}{%
448 \bf@rightcurlyspace +
449 \widthof{\usebox{\curly@box}} +
450 \bf@rightlabelspace +
451 \label@box@width
452 }%
453 \begin{picture}(\strip@pt\total@box@width,0)
454 \put(0,0){%
455 \hspace*{\bf@rightcurlyspace}%
456 \usebox{\curly@box}%
457 \hspace*{\bf@rightlabelspace}%
458 \makebox(\strip@pt\label@box@width,\strip@pt\label@box@height){%
459 \usebox{\word@label@box}%
460 }%
461 }%
462 \end{picture}%
The last thing \show@wordlabelr does is redefine itself back to a no-op.
463 \gdef\show@wordlabelr{}}%
\@currenvir Because of our meddling with \begingroup and \endgroup, the current environ-
ment is all messed up. We therefore force the \end{rightwordgroup} to succeed,
even if it doesn’t match the preceding \begin.
464 \def\@currenvir{rightwordgroup}%
465 \ignorespacesafterend
466 }
3.7.3 Left-side labels
\wordlabell@start
\wordlabell@end
Declare the starting and ending height (in points) of the set of rows to be labeled
on the left.
39
467 \newlength{\wordlabell@start}
468 \newlength{\wordlabell@end}
\total@box@width Declare the total width of the next label to typeset on the left of the bit field, that
is, the aggregate width of the text box, curly brace, and spaces on either side of
the curly brace.
469 \newlength{\total@lbox@width}
\make@lspace This macro is output in the first column of every row of the \ialigned bytefield
table. It’s normally a no-op, but \begin{leftwordgroup} defines it to output
enough space for the next word label and then reset itself to a no-op.
470 \gdef\make@lspace{}
⋆ leftwordgroup (env.) This environment is essentially the same as the rightwordgroup environment but
puts the label on the left. However, the following code is not symmetric to that
of rightwordgroup. The problem is that we encounter \begin{leftwordgroup}
after entering the second (i.e., figure) column, which doesn’t give us a chance
to reserve space in the first (i.e., left label) column. When we reach the
\end{leftwordgroup}, we know the height of the group of words we wish to
label. However, if we try to label the words in the subsequent first column, we
won’t know the vertical offset from the “cursor” at which to start drawing the
label, because we can’t know the height of the subsequent row until we reach the
second column.1
Our solution is to allocate space for the box the next time we enter a first
column. As long as space is eventually allocated, the column will expand to fit
that space. \end{leftwordgroup} outputs the label immediately. Even though
\end{leftwordgroup} is called at the end of the second column, it \puts the label
at a sufficiently negative x location for it to overlap the first column. Because there
will eventually be enough space to accomodate the label, we know that the label
won’t overlap the bit field or extend beyond the bit-field boundaries.
471 \newenvironment{leftwordgroup}[2][]{%
\wordlabell@start
\wordlabell@params
\wordlabell@text
We store the starting height, optional parameters (see Section 2.3), and label text,
all of which are needed by the \end{leftwordgroup}. We immediately parse the
parameters because they may affect the \store@lcurly invocation below.
472 \global\wordlabell@start=\bytefield@height
473 \gdef\wordlabell@params{#1}%
474 \gdef\wordlabell@text{#2}%
475 \bf@bytefieldsetup{#1}%
Next, we typeset a draft version of the label into \word@label@box, which we
measure (into \total@lbox@width) and then discard. We can’t typeset the final
version of the label until we reach the \end{leftwordgroup}, because that’s when
we learn the height of the word group. Without knowing the height of the word
group, we don’t how how big to make the curly brace. In the scratch version, we
make the curly brace 5 cm. tall. This should be more than large enough to reach
the maximum curly-brace width, which is all we really care about at this point.
476 \sbox{\word@label@box}{%
1Question: Is there a way to push the label up to the top of the subsequent row, perhaps
with \vfill?
40
477 \begin{tabular}[b]{@{}l@{}}\wordlabell@text\end{tabular}}%
478 \settowidth{\label@box@width}{\usebox{\word@label@box}}%
479 \store@lcurly{\curly@box}{5cm}%
480 \setlength{\total@lbox@width}{%
481 \bf@leftcurlyspace +
482 \widthof{\usebox{\curly@box}} +
483 \bf@leftlabelspace +
484 \label@box@width}%
485 \global\total@lbox@width=\total@lbox@width
\make@lspace Now we know how wide the box is going to be (unless, of course, the user is using
some weird math font that scales the width of a curly brace proportionally to its
height). So we redefine \make@lspace to output \total@lbox@width’s worth of
space and then redefine itself back to a no-op.
486 \gdef\make@lspace{%
487 \hspace*{\total@lbox@width}%
488 \gdef\make@lspace{}%
489 }%
We now end the group that \begin{rightwordgroup} created. This lets the
leftwordgroup environment span rows (because we’re technically no longer within
the environment).
490 \endgroup
491 \ignorespaces
492 }{%
Because we already ended the group that \begin{leftwordgroup} cre-
ated we have to start the \end{leftwordgroup} by beginning a group for
\end{leftwordgroup} to end.
493 \begingroup
The \end{leftwordgroup} code is comparatively straightforward. We calcu-
late the final height of the word group, and then output the label text, fol-
lowed by \bf@leftlabelspace space, followed by a curly brace (now that we
know how tall it’s supposed to be), followed by \bf@leftcurlyspace space. The
trick, as described earlier, is that we typeset the entire label in the second col-
umn, but in a 0 × 0 picture environment and with a negative horizontal offset
(\starting@point), thereby making it overlap the first column. Before typeset-
ting the curly brace we re-parse the optional parameters because we’re in a new
group from the one in which we parsed them before, and the parameters can affect
the second \store@lcurly invocation just they could have affected the first.
494 \global\wordlabell@end=\bytefield@height
495 \bf@newdimen\starting@point
496 \setlength{\starting@point}{%
497 -\total@lbox@width - \bf@bitwidth*\bits@wide}%
498 \sbox{\word@label@box}{%
499 \begin{tabular}[b]{@{}l@{}}\wordlabell@text\end{tabular}}%
500 \settowidth{\label@box@width}{\usebox{\word@label@box}}%
501 \setlength{\label@box@height}{\wordlabell@end-\wordlabell@start}%
502 \expandafter\bf@bytefieldsetup\expandafter{\wordlabell@params}%
503 \store@lcurly{\curly@box}{\label@box@height}%
504 \begin{picture}(0,0)
505 \put(\strip@pt\starting@point,0){%
41
506 \makebox(\strip@pt\label@box@width,\strip@pt\label@box@height){%
507 \usebox{\word@label@box}}%
508 \hspace*{\bf@leftlabelspace}%
509 \usebox{\curly@box}%
510 \hspace*{\bf@leftcurlyspace}}
511 \end{picture}%
\@currenvir Because of our meddling with \begingroup and \endgroup, the current environ-
ment is all messed up. We therefore force the \end{leftwordgroup} to succeed,
even if it doesn’t match the preceding \begin.
512 \def\@currenvir{leftwordgroup}%
513 \ignorespacesafterend
514 }
3.7.4 Scratch space
\label@box@width
\label@box@height
\word@label@box
Declare some scratch storage for the width, height, and contents of the word label
we’re about to output.
515 \newlength{\label@box@width}
516 \newlength{\label@box@height}
517 \newsavebox{\word@label@box}
3.8 Compatibility mode
\bf@enter@compatibility@mode@i bytefield’s interface changed substantially with the move to version 2.0. To give
version 1.x users a quick way to build their old documents, we provide a version 1.x
compatibility mode. We don’t enable this by default because it exposes a number
of extra length registers (a precious resource) and because we want to encourage
users to migrate to the new interface.
518 \newcommand{\bf@enter@compatibility@mode@i}{%
\bitwidth
\byteheight
\curlyspace
\labelspace
\curlyshrinkage
Define a handful of lengths that the user was allowed to \setlength explicitly in
bytefield 1.x.
519 \PackageInfo{bytefield}{Entering version 1 compatibility mode}%
520 \newlength{\bitwidth}%
521 \newlength{\byteheight}%
522 \newlength{\curlyspace}%
523 \newlength{\labelspace}%
524 \newlength{\curlyshrinkage}%
525 \settowidth{\bitwidth}{\tiny 99i}%
526 \setlength{\byteheight}{4ex}%
527 \setlength{\curlyspace}{1ex}%
528 \setlength{\labelspace}{0.5ex}%
529 \setlength{\curlyshrinkage}{5pt}%
\newbytefield
\endnewbytefield
bytefield (env.)
Redefine the bytefield environment in terms of the existing (new-interface)
bytefield environment. The difference is that the redefinition utilizes all of the
preceding lengths.
530 \let\newbytefield=\bytefield
531 \let\endnewbytefield=\endbytefield
532 \renewenvironment{bytefield}[1]{%
533 \begin{newbytefield}[%
42
534 bitwidth=\bitwidth,
535 bitheight=\byteheight,
536 curlyspace=\curlyspace,
537 labelspace=\labelspace,
538 curlyshrinkage=\curlyshrinkage]{##1}%
539 }{%
540 \end{newbytefield}%
541 }
\wordgroupr
\endwordgroupr
\wordgroupl
\endwordgroupl
Define \wordgroupr, \endwordgroupr, \wordgroupl, and \endwordgroupl in
terms of the new rightwordgroup and leftwordgroup environments.
542 \def\wordgroupr{\begin{rightwordgroup}}
543 \def\endwordgroupr{\end{rightwordgroup}}
544 \def\wordgroupl{\begin{leftwordgroup}}
545 \def\endwordgroupl{\end{leftwordgroup}}
\bytefieldsetup Disable \bytefieldsetup in compatibility mode because it doesn’t work as ex-
pected. (Every use of the compatibility-mode bytefield environment overwrites
all of the figure-formatting values.)
546 \renewcommand{\bytefieldsetup}[1]{%
547 \PackageError{bytefield}{%
548 The \protect\bytefieldsetup\space macro is not available in\MessageBreak
549 version 1 compatibility mode%
550 }{%
551 Remove [compat1] from the \protect\usepackage{bytefield} line to
552 make \protect\bytefieldsetup\MessageBreak
553 available to this document.\space\space (The document may also need
554 to be modified to use\MessageBreak
555 the new bytefield interface.)
556 }%
557 }%
558 }
\wordgroupr
\endwordgroupr
\wordgroupl
\endwordgroupl
Issue a helpful error message for the commands that were removed in bytefield v2.0.
While this won’t help users whose first invalid action is to modify a no-longer-
extant length register such as \bitwidth or \byteheight, it may benefit at least
a few users who didn’t realize that the bytefield interface has changed substantially
with version 2.0.
559 \newcommand{\wordgroupr}{%
560 \PackageError{bytefield}{%
561 Macros \protect\wordgroupr, \protect\wordgroupl, \protect\endwordgroupr,
562 \MessageBreak
563 and \protect\endwordgroupl\space no longer exist%
564 }{%
565 Starting with version 2.0, bytefield uses \protect\begin{wordgroupr}...
566 \MessageBreak
567 \protect\end{wordgroupr} and \protect\begin{wordgroupl}...%
568 \protect\end{wordgroupl}\MessageBreak
569 to specify word groups and a new \protect\bytefieldsetup\space macro to
570 \MessageBreak
571 change bytefield’s various formatting parameters.%
572 }%
573 }
43
574 \let\endwordgroupr=\wordgroupr
575 \let\wordgroupl=\wordgroupr
576 \let\endwordgroupl=\wordgroupr
3.9 Option processing
We use the keyval package to handle option processing. Because all of bytefield’s
options have local impact, options can be specified either as package arguments
or through the use of the \bytefieldsetup macro.
\KV@bytefield@bitwidth
\bf@bw@arg
\bf@auto
Specify the width of a bit number in the bit header. If the special value “auto” is
given, set the width to the width of a formatted “99i”.
577 \define@key{bytefield}{bitwidth}{%
578 \def\bf@bw@arg{#1}%
579 \def\bf@auto{auto}%
580 \ifx\bf@bw@arg\bf@auto
581 \settowidth{\bf@bitwidth}{\bf@bitformatting{99i}}%
582 \else
583 \setlength{\bf@bitwidth}{#1}%
584 \fi
585 }
\KV@bytefield@bf@bitheight Specify the height of a bit in a \bitbox or \wordbox.
586 \define@key{bytefield}{bitheight}{\setlength{\bf@bitheight}{#1}}
\KV@bytefield@bitformatting Specify the style of a bit number in the bit header. This should be passed
an expression that takes either one argument (e.g., \textit) or no arguments
(e.g., {\small\bfseries}).
587 \define@key{bytefield}{bitformatting}{\def\bf@bitformatting{#1}}
\KV@bytefield@boxformatting Specify a style to be applied to the contents of every bit box and word box. This
should be passed an expression that takes either one argument (e.g., \textit) or
no arguments (e.g., {\small\bfseries}).
588 \define@key{bytefield}{boxformatting}{\def\bf@boxformatting{#1}}
\KV@bytefield@leftcurly
\KV@bytefield@rightcurly
\bf@leftcurly
\bf@rightcurly
Specify the symbol to use for bracketing a left or right word group. This must be
an extensible math delimiter (i.e., something that can immediately follow \left
or \right in math mode).
589 \define@key{bytefield}{leftcurly}{\def\bf@leftcurly{#1}}
590 \define@key{bytefield}{rightcurly}{\def\bf@rightcurly{#1}}
\KV@bytefield@leftcurlyspace
\KV@bytefield@rightcurlyspace
\KV@bytefield@curlyspace
\bf@leftcurlyspace
\bf@rightcurlyspace
Specify the amount of space between the bit fields in a word group and the adjacent
left or right curly brace. The curlyspace option is a shortcut that puts the same
space before both left and right curly braces.
591 \define@key{bytefield}{leftcurlyspace}{\def\bf@leftcurlyspace{#1}}
592 \define@key{bytefield}{rightcurlyspace}{\def\bf@rightcurlyspace{#1}}
593 \define@key{bytefield}{curlyspace}{%
594 \def\bf@leftcurlyspace{#1}%
595 \def\bf@rightcurlyspace{#1}%
596 }
44
\KV@bytefield@leftlabelspace
\KV@bytefield@rightlabelspace
\KV@bytefield@labelspace
\bf@leftlabelspace
\bf@rightlabelspace
Specify the amount of space between a left or right word group’s curly brace and
the associated label text. The labelspace option is a shortcut that puts the same
space after both left and right curly braces.
597 \define@key{bytefield}{leftlabelspace}{\def\bf@leftlabelspace{#1}}
598 \define@key{bytefield}{rightlabelspace}{\def\bf@rightlabelspace{#1}}
599 \define@key{bytefield}{labelspace}{%
600 \def\bf@leftlabelspace{#1}%
601 \def\bf@rightlabelspace{#1}%
602 }
V@bytefield@leftcurlyshrinkage
@bytefield@rightcurlyshrinkage
\KV@bytefield@curlyshrinkage
\bf@leftcurlyshrinkage
\bf@rightcurlyshrinkage
Specify the number of points by which to reduce the height of a curly brace (left,
right, or both) so its ends don’t overlap whatever’s above or below it.
603 \define@key{bytefield}{leftcurlyshrinkage}{\def\bf@leftcurlyshrinkage{#1}}
604 \define@key{bytefield}{rightcurlyshrinkage}{\def\bf@rightcurlyshrinkage{#1}}
605 \define@key{bytefield}{curlyshrinkage}{%
606 \def\bf@leftcurlyshrinkage{#1}%
607 \def\bf@rightcurlyshrinkage{#1}%
608 }
\KV@bytefield@leftcurlystyle
\KV@bytefield@rightcurlystyle
\KV@bytefieldcurlystyle
\bf@leftcurlystyle
\bf@rightcurlystyle
Specify a macro that takes either zero or one argument and that precedes the text
that draws a left curly brace, right curly brace, or either curly brace.
609 \define@key{bytefield}{leftcurlystyle}{\def\bf@leftcurlystyle{#1}}
610 \define@key{bytefield}{rightcurlystyle}{\def\bf@rightcurlystyle{#1}}
611 \define@key{bytefield}{curlystyle}{%
612 \def\bf@leftcurlystyle{#1}%
613 \def\bf@rightcurlystyle{#1}%
614 }
\KV@bytefield@endianness
\bf@parse@endianness
Set the default endianness to either little endian or big endian.
615 \define@key{bytefield}{endianness}{\bf@parse@endianness{#1}}
616 \newcommand{\bf@parse@endianness}[1]{%
617 \def\bf@little{little}%
618 \def\bf@big{big}%
619 \def\bf@arg{#1}%
620 \ifx\bf@arg\bf@little
621 \def\bf@bit@endianness{l}%
622 \else
623 \ifx\bf@arg\bf@big
624 \def\bf@bit@endianness{b}%
625 \else
626 \PackageError{bytefield}{%
627 Invalid argument "#1" to the endianness option%
628 }{%
629 The endianness option must be set to either "little" or
630 "big".\MessageBreak
631 Please specify either endianness=little or endianness=big.
632 }%
633 \fi
634 \fi
635 }
\KV@bytefield@lsb Specify a numerical value for the least significant bit of a word.
636 \define@key{bytefield}{lsb}{\def\bf@first@bit{#1}}
45
\bf@bgcolor
\KV@bytefield@bgcolor
Specify a background color for a bit box or word box.
637 \define@key{bytefield}{bgcolor}{\def\bf@bgcolor{#1}}
\bf@per@word
\KV@bytefield@per@word
Specify a macro to invoke for each word of a word box. The macro must take two
arguments: the word number (0-indexed) and the total number of words.
638 \define@key{bytefield}{perword}{\def\bf@per@word{#1}}
⋆ \bytefieldsetup
\bf@bytefieldsetup
Reconfigure values for various bytefield parameters. Internally to the package we
use the \bf@bytefieldsetup macro instead of \bytefieldsetup. This enables us
to redefine \bytefieldsetup when entering version 1 compatibility mode without
impacting the rest of bytefield.
639 \newcommand{\bf@bytefieldsetup}{\setkeys{bytefield}}
640 \let\bytefieldsetup=\bf@bytefieldsetup
We define only a single option that can be used only as a package option, not as
an argument to \bytefieldsetup: compat1 instructs bytefield to enter version 1
compatibility mode—at the cost of a number of additional length registers and the
inability to specify parameters in the argument to the bytefield environment.
641 \DeclareOption{compat1}{\bf@enter@compatibility@mode@i}
\bf@package@options
\next
We want to use \bf@bytefieldsetup to process bytefield package options. Un-
fortunately, \DeclareOption doesn’t handle ⟨key⟩=⟨value⟩ arguments. Hence,
we use \DeclareOption* to catch all options, each of which it appends to
\bf@package@options. \bf@package@options is passed to \bf@bytefieldsetup
only at the beginning of the document so that the options it specifies (a) can re-
fer to ex-heights and (b) override the default values, which are also set at the
beginning of the document.
642 \def\bf@package@options{}
643 \DeclareOption*{%
644 \edef\next{%
645 \noexpand\g@addto@macro\noexpand\bf@package@options{,\CurrentOption}%
646 }%
647 \next
648 }
649 \ProcessOptions\relax
650 \expandafter\bf@bytefieldsetup\expandafter{\bf@package@options}
4 Future work
bytefield is my first LATEX package, and, as such, there are a number of macros
that could probably have been implemented a lot better. For example, bytefield
is somewhat wasteful of ⟨dimen⟩ registers (although it did get a lot better with
version 1.1 and again with version 1.3). The package should really get a major
overhaul now that I’ve gotten better at TEX/LATEX programming. One minor
improvement I’d like to make in the package is to move left, small curly braces
closer to the bit field. In the following figure, notice how distant the small curly
appears from the bit-field body:
46
SomethingToo distant
n
Something elseLooks okay



The problem is that the curly braces are left-aligned relative to each other, while
they should be right-aligned.
Change History
v1.0
General: Initial version . . . . . . . . 1
v1.1
General: Restructured the .dtx file 1
\bf@newdimen: Bug fix: Added
\bf@newdimen to greatly reduce
the likelihood of “No room for
a new \dimen” errors
(reported by Vitaly A. Repin) 25
\bf@parse@range@list: Bug fix:
Swapped order of arguments to
\ifx test (suggested by
Hans-Joachim Widmaier) . . . 35
v1.2
\curly@box: Bug fix: Defined
\curly@box globally (suggested
by Stefan Ulrich) . . . . . . . . . 37
v1.2a
General: Specified an explicit
package date when loading the
calc package to avoid loading
an outdated version. Thanks
to Kevin Quick for discovering
that outdated versions of calc
are still being included in TEX
distributions. . . . . . . . . . . . . 25
v1.3
\bf@newdimen: Added support for
ε-TEX’s larger local ⟨dimen⟩
pool (code provided by Heiko
Oberdiek) . . . . . . . . . . . . . . . 25
v1.4
General: Made assignments to
\counting@words global to
prevent vertical-spacing
problems with back-to-back
word groups (bug fix due to
Steven R. King) . . . . . . . . . . . 1
Split \curlyspace,
\labelspace, and
\curlyshrinkage into left
and right versions . . . . . . . . . 1
\bf@bitformatting: Introduced
this macro at Steven R. King’s
request to enable users to alter
the bit header’s font size . . . . 27
v2.0
General: Made a number of
non-backwards-compatible
changes, including replacing
\wordgroupr and
\endwordgroupr with a
rightwordgroup environment
and \wordgroupl and
\endwordgroupl with a
leftwordgroup environment
and also replacing a slew of
user-visible lengths and macros
with a single \bytefieldsetup
macro . . . . . . . . . . . . . . . . . . 1
\bytefieldsetup: Introduced this
macro to provide a more
convenient way of configuring
bytefield’s parameters . . . . . . 46
v2.1
General: Included in the
documentation a
variable-height memory-map
example suggested by Martin
Demling . . . . . . . . . . . . . . . . 21
\\: Augmented the definition of \\
to accept an optional
argument, just like in a
tabular environment . . . . . . 27
\bf@parse@range: Added code due
to Renaud Pacalet for shifting
47
the bit header by a distance
corresponding to
\bf@first@bit, used for
typesetting registers split
across rows . . . . . . . . . . . . . . 35
\bitheader: Changed the optional
argument to accept
⟨key⟩=⟨value⟩ pairs instead of
just “l” and “b” . . . . . . . . . . 35
v2.2
\bitboxes: Added this macro
based on an idea proposed by
Andrew Mertz . . . . . . . . . . . 31
v2.3
\bf@newdimen: Rewrote the macro
based on discussions with
David Carlisle to avoid
producing “No room for a
new \dimen” errors in newer
versions of ε-TEX (see
http://tex.stackexchange.
com/q/275042) . . . . . . . . . . . 25
v2.4
bytefield: Make the code resilient
to changes in
\baselinestretch. Thanks to
Karst Koymans for the bug
report . . . . . . . . . . . . . . . . . 26
v2.5
General: Accept a new bgcolor
option to set a bit’s
background color . . . . . . . . . . 1
Accept a new perword option to
execute a macro for each word
in a word box. This addresses a
feature request by Victor Toni . 1
Redefine the \bitbox, \wordbox,
and \bitboxes commands
additionally to accept
key/value options . . . . . . . . . . 1
v2.6
General: Accept new curlystyle,
leftcurlystyle, and
rightcurlystyle options to
control the styling (e.g., color)
of curly braces. This addresses
a feature request by Victor
Toni . . . . . . . . . . . . . . . . . . . . 1
leftwordgroup: Accept key/value
options . . . . . . . . . . . . . . . . . 40
Suppress spaces following the
\end{leftwordgroup} . . . . . . 40
rightwordgroup: Accept key/value
options . . . . . . . . . . . . . . . . . 38
Suppress spaces following the
\end{rightwordgroup} . . . . . 38
v2.7
\store@lcurly: Properly align left
curly braces under LuaLATEX
(bug reported by Georgi
Nikiforov) . . . . . . . . . . . . . . . 37
\store@rcurly: Properly align
right curly braces under
LuaLATEX (bug reported by
Georgi Nikiforov) . . . . . . . . . 37
v2.8
General: Corrected the
documentation. Thanks to
¨Omer Faruk Birg¨ul for pointing
out an error in one of the
examples . . . . . . . . . . . . . . . . 1
v2.9
\bf@newdimen: Rewrite
\bf@newdimen yet again so as
to allocate ⟨dimen⟩s locally in
newer versions of LATEX.
Thanks to Qian Jin for the bug
report . . . . . . . . . . . . . . . . . 25
Index
Numbers written in italic refer to the page where the corresponding entry is de-
scribed; numbers underlined refer to the code line of the definition; numbers in
roman refer to the code lines where the entry is used.
Symbols
\@currenvir . . . . . . . . . . . . . . 464, 512
\@ne . . . . . . . . . . . . . . . . . . . . . . . . 10
\\ . . . . . . . . . . . . . . . . . . . . . . . . . 50
A
\addtolength . . . . . . . . . . . . . 395, 415
\allocationnumber . 5, 6, 7, 12, 13, 14
\amp . . . . . . . . . . . . . . 37, 53, 54, 55, 58
\AtBeginDocument . . . . . . . . . . . . . 16
48
B
\baselinestretch . . . . . . . . . . . . . 39
\bf@arg . . . . . . . . . . . . . 619, 620, 623
\bf@auto . . . . . . . . . . . . . . . . . . . . 577
\bf@bgcolor . . . . . . . . . . . 94, 116, 637
\bf@big . . . . . . . . . . . . . . . . . 618, 623
\bf@bit@endianness . . . . . . . . . . . .
. . . . . 303, 336, 363, 373, 621, 624
\bf@bitbox . . 84, 85, 195, 209, 213, 229
\bf@bitboxes@arg@ii . . . . . . . 205, 218
\bf@bitboxes@no@star . . . . . . 183, 186
\bf@bitboxes@no@star@i . . . . 187, 190
\bf@bitboxes@sides . 200, 212, 222, 224
\bf@bitboxes@star . . . . . . . . 182, 200
\bf@bitboxes@star@i . . . . . . . 202, 205
\bf@bitboxes@star@ii . . . . . . 214, 218
\bf@bitformatting . . . . . . . . . . . .
. . . . . . 62, 65, 308, 344, 581, 587
\bf@bitheight . . . . . . . . . . . . . . . .
. . . . 66, 93, 99, 110, 154, 157, 586
\bf@bitwidth . . . . 64, 88, 109, 286,
307, 338, 340, 343, 497, 581, 583
\bf@boxformatting . . . . . 63, 132, 588
\bf@bw@arg . . . . . . . . . . . . . . . . . . 577
\bf@bytefieldsetup . . . . . . . . . 38,
89, 111, 444, 475, 502, 639, 650
\bf@call@box@arg@i . . . . . . . . . . . .
. . . 74, 87, 108, 201, 212, 222, 224
\bf@call@box@arg@ii . . 74, 88, 110, 124
\bf@call@box@arg@iii . . . . 79, 89, 111
\bf@call@box@arg@iv . . . . . 79, 100,
122, 187, 191, 192, 202, 205, 218
\bf@call@box@cmd 70, 84, 105, 182, 183
\bf@call@box@cmd@i . . . . . . . . . . 72, 74
\bf@call@box@cmd@ii . . . . . . . . . 77, 79
\bf@call@box@func . . . . . . . . . . 70, 82
\bf@e@alloc . . . . . . . . . . . . . . . . . 9, 22
\bf@enter@compatibility@mode@i .
. . . . . . . . . . . . . . . . . . . 518, 641
\bf@first@bit . . . . . 304, 338, 340, 636
\bf@invoke@per@word . . . . . . . 124, 151
\bf@leftcurly . . . . . . . . 381, 418, 589
\bf@leftcurlyshrinkage . . . . . . . .
. . . . . . . . . . . . 375, 409, 413, 603
\bf@leftcurlyspace . 377, 481, 510, 591
\bf@leftcurlystyle . . . . 383, 417, 609
\bf@leftlabelspace . 377, 483, 508, 597
\bf@little . . . . . . . . . . . . . . 617, 620
\bf@newdimen . . . . . . . . . . . . . . . . .
. . 16, 169, 170, 171, 172, 388,
390, 392, 408, 410, 412, 446, 495
\bf@newdimen@old . . . . . . . . . . . . 3, 19
\bf@package@options . . . . . . . . . . . 642
\bf@parse@bitbox@arg 87, 108, 238, 306
\bf@parse@bitbox@sides . . . . 243, 245
\bf@parse@endianness . . . . . . . . . . 615
\bf@parse@range . . . . . . . . . . 324, 331
\bf@parse@range@list . . . . . . 313, 321
\bf@per@word . . . . . . . . . . . . . 160, 638
\bf@process@bitheader@opts . 310, 348
\bf@relax . . . . 185, 192, 208, 221, 226
\bf@rightcurly . . . . . . . 381, 401, 589
\bf@rightcurlyshrinkage . . . . . . .
. . . . . . . . . . . . 375, 389, 393, 603
\bf@rightcurlyspace 377, 448, 455, 591
\bf@rightcurlystyle . . . 383, 397, 609
\bf@rightlabelspace 377, 450, 457, 597
\bf@set@user@dimens . . . 131, 155, 168
\bf@wordbox . . . . . . . . . . . . . . 105, 106
bgcolor (option) . . . . . 4, 11, 17, 28, 29
\bitbox . . . . . . . . . . . . . . . . . . . 3, 84
\bitbox@bottomfalse . . . . . . . 240, 264
\bitbox@bottomtrue . . . . . . . . . . . . 252
\bitbox@leftfalse . . . . . . . . 241, 267
\bitbox@lefttrue . . . . . . . . . . . . . 255
\bitbox@rightfalse . . . . . . . . 242, 270
\bitbox@righttrue . . . . . . . . . . . . 258
\bitbox@topfalse . . . . . . . . . 239, 261
\bitbox@toptrue . . . . . . . . . . . . . . 249
\bitboxes . . . . . . . . . . . . . . . . . 4, 180
\bitboxes* . . . . . . . . . . . . . . . . . . 180
bitformatting (option) . . . . . . . 8–10, 16
\bitheader . . . . . . . . . 5, 305, 358, 368
bitheight (option) . . . . . . . . . . . . . . . 8
\bits@wide . 37, 109, 286, 307, 338, 497
\bitwidth . . . . . . . . . . 23, 24, 519, 534
bitwidth (option) . . . . . . . . 8–10, 19, 24
boxformatting (option) . . . . 8, 10, 11, 18
\bytefield . . . . . . . . . . . . . . . . . . 530
bytefield (package) 1–4, 8, 11, 14, 16–
20, 22–26, 34, 36, 42–44, 46, 48, 49
bytefield (env.) . . . . . . . . . 3, 37, 530
\bytefield@height . . . . . . . . . . . .
. . . . 29, 34, 46, 431, 437, 472, 494
\bytefield@height@increment . . . .
. . . . . . . . . . . . . . . . . . 31, 33, 34
\bytefieldsetup . . . . . 8, 546, 569, 639
\byteheight . . . . . . . . . . . 24, 519, 535
C
calc (package) . . . . . . . . . . . . . . . . . 26
\centering . . . . . . . . . . . . . . . . . . 63
\color . . . . . . . . . . . . . . . . . . . 94, 116
color (package) . . . . . . . . . . . . . . . . 11
compat1 (option) . . . . . . . . . . . . . . 36
\counting@wordsfalse . . 148, 300, 317
\counting@wordstrue . . . . . . . . . 48, 54
49
\curly@box . . . . . . . . . . . . . . 385,
445, 449, 456, 479, 482, 503, 509
\curly@height . . . . . . . . . . . . 386, 406
\curly@shift . . . . . . . . . . . . . 386, 406
\curlyshrinkage . . . . . . . 24, 519, 538
curlyshrinkage (option) . . . . . . . . . . . 12
\curlyspace . . . . . . . . . . . 24, 519, 536
curlyspace (option) . . . . . . . . 11, 12, 44
curlystyle (option) . . . . . . . . . . . . 6, 12
\CurrentOption . . . . . . . . . . . . . . . 645
D
\DeclareOption . . . . . . . . . . . 641, 643
\define@key 355, 365, 577, 586, 587,
588, 589, 590, 591, 592, 593,
597, 598, 599, 603, 604, 605,
609, 610, 611, 615, 636, 637, 638
\depth . . . . . . . . . . . . . . . . . . . . . . 168
\draw@bit@picture 93, 99, 115, 121, 128
E
\e@ch@ck . . . . . . . . . . . . . . . . . . . . 11
elocalloc (package) . . . . . . . . . . . 25, 26
\endbytefield . . . . . . . . . . . . . . . . 531
endianness (option) . . . . . . . . . . . . 5, 9
\endnewbytefield . . . . . . . . . . . . . 530
\endwordgroupl . . . . . . . . 23, 542, 559
\endwordgroupr . . . . . . . . 23, 542, 559
\entire@bytefield@picture . 36, 49, 60
environments:
bytefield . . . . . . . . . . . . 3, 37, 530
leftwordgroup . . . . . . . . . . . 6, 471
rightwordgroup . . . . . . . . . . 6, 429
F
\float@count . . . . . . . . . . . . . . . . . 22
\fontdimen . . . . . . . . . . . . . . 395, 415
G
\g@addto@macro . . . . . . . . . . . . . . . 645
graphicx (package) . . . . . . . . . . . . . . 16
H
\half@curly@height . . . . . . . . 386, 406
\header@val . . . . . . . . . . . . . . . . . . 328
\header@xpos . . . . . . 328, 337, 340, 342
\height . . . . . . . . . . . . . . 95, 117, 168
\heightof . . . . . . . . . . . . . . . . . . . 308
\heightunits . . . . . . . . . . . . . . . . . 168
I
\ialign . . . . . . . . . . . . . . . . . . . . . 55
\ifbitbox@bottom . . . . . . . . . 136, 234
\ifbitbox@left . . . . . . . . . . . 139, 234
\ifbitbox@right . . . . . . . . . . 142, 234
\ifbitbox@top . . . . . . . . . . . . 133, 234
\ifcounting@words . . 29, 146, 298, 315
\ignorespacesafterend . . . . . 465, 513
\inc@bytefield@height 31, 147, 299, 316
K
\KV@bitheader@b . . . . . . . . . . 350, 355
\KV@bitheader@b@default . . . . . . . 352
\KV@bitheader@l . . . . . . . . . . 349, 355
\KV@bitheader@l@default . . . . . . . 351
\KV@bytefield@b . . . . . . . . . . . . . . 348
\KV@bytefield@b@default . . . . . . . 348
\KV@bytefield@bf@bitheight . . . . . 586
\KV@bytefield@bgcolor . . . . . . . . . 637
\KV@bytefield@bitformatting . . . . 587
\KV@bytefield@bitwidth . . . . . . . . 577
\KV@bytefield@boxformatting . . . . 588
\KV@bytefield@curlyshrinkage . . . 603
\KV@bytefield@curlyspace . . . . . . . 591
\KV@bytefield@endianness . . . . . . . 615
\KV@bytefield@l . . . . . . . . . . . . . . 348
\KV@bytefield@l@default . . . . . . . 348
\KV@bytefield@labelspace . . . . . . . 597
\KV@bytefield@leftcurly . . . . . . . 589
\KV@bytefield@leftcurlyshrinkage 603
\KV@bytefield@leftcurlyspace . . . 591
\KV@bytefield@leftcurlystyle . . . 609
\KV@bytefield@leftlabelspace . . . 597
\KV@bytefield@lsb . . . . . . . . . . . . 636
\KV@bytefield@per@word . . . . . . . . 638
\KV@bytefield@rightcurly . . . . . . . 589
\KV@bytefield@rightcurlyshrinkage
. . . . . . . . . . . . . . . . . . . . . . 603
\KV@bytefield@rightcurlyspace . . 591
\KV@bytefield@rightcurlystyle . . 609
\KV@bytefield@rightlabelspace . . 597
\KV@bytefieldcurlystyle . . . . . . . 609
L
\label@box@height . . . . . . . . . . . .
. 443, 445, 458, 501, 503, 506, 515
\label@box@width . . . . . . . . . 442,
451, 458, 478, 484, 500, 506, 515
\labelspace . . . . . . . . . . . 24, 519, 537
leftcurly (option) . . . . . . . . . . . 8, 11, 12
leftcurlyshrinkage (option) . . . . . . . . 12
leftcurlyspace (option) . . . . . . . . . 11, 12
leftcurlystyle (option) . . . . . . . . . . 6, 12
leftwordgroup (env.) . . . . . . . . . 6, 471
\line . . . . . . . . . . . . . . . . . . . 134,
137, 140, 143, 293, 294, 295, 296
\locdimen . . . . . . . . . . . . . . . . . . . 26
lsb (option) . . . . . . . . . . . . . . 13, 16, 35
50
M
\make@lspace . . . . . . . . . . 54, 470, 486
\makebox . . . . . . . . . 130, 343, 458, 506
\max@header@val . . . . . . . . . . . . . . 328
N
\newbytefield . . . . . . . . . . . . . . . . 530
\next . . . . . . . . . . . . . . . 205, 218, 642
\num@high . . . . . . . . . . . 291, 295, 296
\num@tall . . . . 290, 292, 293, 296, 299
\num@wide . . . . 289, 292, 293, 294, 296
O
\old@axis . . . . . . . . . . . . . . . . . . . 386
\old@nl . . . . . . . . . . . . . . . . . . . . . 37
\openup . . . . . . . . . . . . . . . . . . . . . 45
options:
bgcolor . . . . . . . . . 4, 11, 17, 28, 29
bitformatting . . . . . . . . . . . 8–10, 16
bitheight . . . . . . . . . . . . . . . . . . . 8
bitwidth . . . . . . . . . . . . 8–10, 19, 24
boxformatting . . . . . . . 8, 10, 11, 18
compat1 . . . . . . . . . . . . . . . . . . 36
curlyshrinkage . . . . . . . . . . . . . . 12
curlyspace . . . . . . . . . . . . 11, 12, 44
curlystyle . . . . . . . . . . . . . . . . 6, 12
endianness . . . . . . . . . . . . . . . . 5, 9
leftcurly . . . . . . . . . . . . . . . 8, 11, 12
leftcurlyshrinkage . . . . . . . . . . . . 12
leftcurlyspace . . . . . . . . . . . . . 11, 12
leftcurlystyle . . . . . . . . . . . . . . 6, 12
lsb . . . . . . . . . . . . . . . . . 13, 16, 35
perword . . . . . . . . . . . . . . . . . . . 14
rightcurly . . . . . . . . . . . . . . 8, 11, 12
rightcurlyshrinkage . . . . . . . . . . . 12
rightcurlyspace . . . . . . . . . . . . 11, 12
rightcurlystyle . . . . . . . . . . . . . 6, 12
P
\PackageError . . . . . . . . 547, 560, 626
\PackageInfo . . . . . . . . . . . . . . . . . 519
packages:
bytefield . . . . 1–4, 8, 11, 14, 16–
20, 22–26, 34, 36, 42–44, 46, 48, 49
calc . . . . . . . . . . . . . . . . . . . . . . 26
color . . . . . . . . . . . . . . . . . . . . . 11
elocalloc . . . . . . . . . . . . . . . . 25, 26
graphicx . . . . . . . . . . . . . . . . . . 16
register . . . . . . . . . . . . . . . . . . . 18
rotating . . . . . . . . . . . . . . . . . . . 18
xcolor . . . . . . . . . . . . . . . . . . . . 11
\PackageWarning . . . . . . 272, 357, 367
\parbox . . . . . . . . . . . . . . . . . . . . . 130
perword (option) . . . . . . . . . . . . . . . 14
\ProcessOptions . . . . . . . . . . . . . . 649
\put . . . 130, 134, 137, 140, 143, 159,
293, 294, 295, 296, 342, 454, 505
R
register (package) . . . . . . . . . . . . . . 18
\RequirePackage . . . . . . . . . . . . . 1, 2
rightcurly (option) . . . . . . . . . . 8, 11, 12
rightcurlyshrinkage (option) . . . . . . . 12
rightcurlyspace (option) . . . . . . . . 11, 12
rightcurlystyle (option) . . . . . . . . . 6, 12
rightwordgroup (env.) . . . . . . . . 6, 429
\rlap . . . . . . . . . . . . . . . . . . . . 92, 114
rotating (package) . . . . . . . . . . . . . . 18
\rule . . . . . . . . . . . . . . . . . . . . 95, 117
S
\selectfont . . . . . . . . . . . . . . . . . . 40
\setkeys . . . . . . . . . . . . . . . . 353, 639
\show@wordlabelr . . . . 53, 58, 426, 438
\skippedwords . . . . . . . . . . . . . . 7, 285
\starting@point . . . . . . 495, 496, 505
\store@lcurly . . . . . . . . 406, 479, 503
\store@rcurly . . . . . . . . . . . . 386, 445
T
\textfont . . . . . . . . . . . . . . . 395, 415
\theheader@val . . . . . . . . . . . . . . . 344
\tiny . . . . . . . . . . . . . . . . . . . . 62, 525
\total@box@width . . 446, 447, 453, 469
\total@lbox@width . . . . . . . . . . . .
. . . . . . . . 469, 480, 485, 487, 497
\totalheight . . . . . . . . . . . . . . . . . 168
U
\unitlength . . . . . . . . . . . . . . . 47,
130, 147, 173, 174, 176, 299, 316
\units@high 284, 287, 288, 291, 309, 312
\units@tall . 68, 110, 115, 121, 155,
288, 290, 308, 309, 311, 316, 343
\units@wide . . . . . . . . . . . . . . . . . .
. 68, 88, 93, 99, 109, 115, 121,
155, 159, 286, 287, 289, 307, 311
V
\vrule . . . . . . . . . . . . . . . . . . 399, 419
W
\width . . . . . . . . . . . . . . . 95, 117, 168
\widthof . . . . . . . . . . . . . . . . 449, 482
\widthunits . . . . . . . . . . . . . . . . . . 168
\word@label@box . . . . . . . 439, 442,
459, 476, 478, 498, 500, 507, 515
\wordbox . . . . . . . . . . . . . . . . . . 3, 105
\wordgroupl . . . . . . . . . . . 23, 542, 559
51
\wordgroupr . . . . . . . . . . . 23, 542, 559
\wordlabell@end . . . . . . 467, 494, 501
\wordlabell@params . . . . . . . . 472, 502
\wordlabell@start . . . . 467, 472, 501
\wordlabell@text . . . . . 472, 477, 499
\wordlabelr@end . . . . . . 427, 436, 443
\wordlabelr@params . . . . . . . . 431, 444
\wordlabelr@start . . . . 427, 431, 443
\wordlabelr@text . . . . . . . . . 431, 440
X
xcolor (package) . . . . . . . . . . . . . . . 11
52
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
V=2 P X CC M PT sequence number
timestamp



RTP
Header
synchronization source (SSRC) identifier
contributing source (CSRC) identifiers
· · ·
MPEG-4 Visual stream (byte aligned)
. . . optional RTP padding



RTP
Payload
Figure 1: Sample bytefield output
· · · ⟨bit-field rows⟩

⟨label ⟩
| {z }
rightcurlyspace
| {z }
rightlabelspace
Figure 2: Role of rightcurlyspace and rightlabelspace
53
0 7 8 15 16 23 24 31
Data
offset Reserved U
R
G
A
C
K
P
S
H
R
S
T
S
Y
N
F
I
N Window
Checksum Urgent pointer



These words
were taken
verbatim
from the
TCP header
definition
(RFC 793).
Data octets
hhhhhhhhhhhhhhhhhhhhhhhhhhhhh
hhhhhhhhhhhhhhhhhhhhhhhhhhhhh
Source Destination
Timestamp
Length
Note that we
can display,
for example,
a misaligned
64-bit value
with clever
use of the
optional
argument to
\wordbox
and \bitbox.



Key Value Unused Length



Why two
Length
fields? No
particular
reason.
Total number of 16-bit data words that follow this header word,
excluding the subsequent checksum-type value
Data 1 Data 2
Data 3 Data 4
... ...
Data N − 1 Data N
A5A5H ⊕
NX
i=1
Datai
!
mod 220 0 0 0 0 1 0 0 0 0 1 1 0
64-bit random number
Figure 3: Complex protocol diagram drawn with the bytefield package
54